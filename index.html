<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConnectSoft - Controle de Clientes e Contratos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            /* Connect Soft theme colors - baseado na logomarca */
            --primary: #8B1538;
            --primary-dark: #6B0F2A;
            --primary-light: #A91B42;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #06b6d4;
            
            /* Neutral colors */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* Semantic colors */
            --background: var(--white);
            --surface: var(--gray-50);
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --border: var(--gray-200);
            --shadow: rgba(0, 0, 0, 0.1);
            
            /* Layout */
            --sidebar-width: 280px;
            --header-height: 64px;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }

        [data-theme="dark"] {
            --background: var(--gray-900);
            --surface: var(--gray-800);
            --text-primary: var(--gray-100);
            --text-secondary: var(--gray-400);
            --border: var(--gray-700);
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            border-right: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            .sidebar {
                position: fixed;
                transform: translateX(0);
            }
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-nav {
            padding: var(--spacing-md) 0;
        }

        .nav-group {
            margin-bottom: var(--spacing-lg);
        }

        .nav-group-title {
            padding: var(--spacing-sm) var(--spacing-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        [data-theme="dark"] .nav-item:hover {
            background: var(--gray-700);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-item i {
            width: 20px;
            margin-right: var(--spacing-md);
        }

        .nav-badge {
            margin-left: auto;
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 1024px) {
            .main-content {
                margin-left: var(--sidebar-width);
            }
        }

        /* Header */
        .header {
            height: var(--header-height);
            background: var(--primary);
            border-bottom: 1px solid var(--primary-dark);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .sidebar-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            border-radius: var(--border-radius);
            margin-right: var(--spacing-md);
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (min-width: 1024px) {
            .sidebar-toggle {
                display: none;
            }
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.6);
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .search-bar {
            position: relative;
            width: 300px;
            max-width: 100%;
        }

        .search-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            padding-left: 2.5rem;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .header-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .header-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: var(--spacing-xs);
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: var(--spacing-md);
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 1px 3px var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-content {
            padding: var(--spacing-lg);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .kpi-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .kpi-icon.primary { background: var(--primary); }
        .kpi-icon.success { background: var(--success); }
        .kpi-icon.warning { background: var(--warning); }
        .kpi-icon.info { background: var(--info); }

        .kpi-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .kpi-content p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        [data-theme="dark"] .table th {
            background: var(--gray-800);
        }

        .table td {
            color: var(--text-primary);
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        [data-theme="dark"] .table tr:hover {
            background: var(--gray-800);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            background: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        [data-theme="dark"] .btn-secondary {
            background: var(--gray-700);
            color: var(--text-primary);
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: var(--gray-600);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            background: var(--background);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Modals */
        body.modal-open {
            overflow: hidden;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
        }

        /* Modal sections */
        .modal-subtitle {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: var(--spacing-md) 0 var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border);
        }

        /* Input action (e.g., show/hide password) */
        .input-with-action {
            position: relative;
        }

        .input-with-action .form-input {
            padding-right: 2.5rem; /* space for the toggle button */
        }

        .password-toggle {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
        }

        .password-toggle:hover {
            color: var(--text-primary);
            background: var(--background);
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--text-primary);
        }

        [data-theme="dark"] .modal-close:hover {
            background: var(--gray-700);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-ativo {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-inativo {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .status-pendente {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-suspenso {
            background: rgba(100, 116, 139, 0.1);
            color: var(--secondary);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-info {
            border-left: 4px solid var(--info);
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--border-radius);
        }

        .toast-close:hover {
            background: var(--gray-100);
        }

        [data-theme="dark"] .toast-close:hover {
            background: var(--gray-700);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-5 { margin-bottom: var(--spacing-xl); }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: var(--spacing-md);
            }
            
            .page-title {
                font-size: 1.5rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .search-bar {
                width: 200px;
            }
            
            .header-actions {
                gap: var(--spacing-sm);
            }
        }

        @media (max-width: 480px) {
            .search-bar {
                display: none;
            }
            
            .modal-content {
                width: 95%;
                margin: var(--spacing-md);
            }
        }

        /* Login Screen Styles */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 400px;
            margin: var(--spacing-md);
        }

        [data-theme="dark"] .login-card {
            background: var(--gray-800);
            border: 1px solid var(--border);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-logo {
            width: 64px;
            height: 64px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-md);
            color: white;
            font-size: 1.5rem;
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .login-form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .login-form-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .login-form-input {
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background: var(--background);
            color: var(--text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .login-form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .login-btn {
            padding: var(--spacing-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .login-btn:hover {
            background: var(--primary-dark);
        }

        .login-btn:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
        }

        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            display: none;
        }

        [data-theme="dark"] .login-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        /* Estilos para Estatísticas - Barras de Avaliação */
        .avaliacao-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            background: var(--surface);
        }

        .avaliacao-label {
            min-width: 120px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .avaliacao-bar {
            flex: 1;
            height: 20px;
            background: var(--gray-200);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        [data-theme="dark"] .avaliacao-bar {
            background: var(--gray-700);
        }

        .avaliacao-progress {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .avaliacao-count {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-lock"></i>
                </div>
                <h1 class="login-title">ConnectSoft Clientes</h1>
                <p class="login-subtitle">Faça login para acessar o sistema</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div class="login-error" id="loginError"></div>
                
                <div class="login-form-group">
                    <label class="login-form-label" for="loginUsername">Usuário</label>
                    <input 
                        type="text" 
                        id="loginUsername" 
                        class="login-form-input" 
                        placeholder="Digite seu usuário"
                        required
                    >
                </div>
                
                <div class="login-form-group">
                    <label class="login-form-label" for="loginPassword">Senha</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="login-form-input" 
                        placeholder="Digite sua senha"
                        required
                    >
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="sidebar-title">CS-Controle</div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Principal</div>
                    <button class="nav-item" onclick="navigateTo('dashboard')">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </button>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Operações</div>
                    <button class="nav-item" onclick="navigateTo('clientes')">
                        <i class="fas fa-users"></i>
                        Clientes
                        <span class="nav-badge" id="clientesBadge">0</span>
                    </button>
                    <button class="nav-item" onclick="navigateTo('contratos')">
                        <i class="fas fa-file-contract"></i>
                        Contratos
                        <span class="nav-badge" id="contratosBadge">0</span>
                    </button>
                    <button class="nav-item" onclick="navigateTo('chaves')">
                        <i class="fas fa-key"></i>
                        Chaves de Liberação
                        <span class="nav-badge" id="chavesBadge">0</span>
                    </button>
                    <button class="nav-item" onclick="navigateTo('estatisticas')">
                        <i class="fas fa-chart-pie"></i>
                        Estatísticas
                    </button>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Configurações</div>
                    <button class="nav-item" onclick="toggleTheme()">
                        <i class="fas fa-palette"></i>
                        Tema
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                
                <nav class="breadcrumbs" id="breadcrumbs">
                    <span>Dashboard</span>
                </nav>
                
                <div class="header-actions">
                    <button class="header-btn" id="themeToggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <button class="header-btn" id="alertToggle" title="Silenciar/reativar alertas">
                        <i class="fas fa-bell"></i>
                    </button>
                    
                    <div class="user-info" style="display: flex; align-items: center; gap: var(--spacing-sm); margin-right: var(--spacing-md);">
                        <span id="currentUserName" style="color: white; font-size: 0.875rem; font-weight: 500;"></span>
                        <i class="fas fa-user-circle" style="color: white;"></i>
                    </div>
                    
                    <button class="header-btn" onclick="logout()" title="Sair do sistema">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Content -->
            <main class="content" id="mainContent">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page">
                    <div class="dashboard-grid">
                        <div class="kpi-card">
                            <div class="kpi-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 id="totalClientes">0</h3>
                                <p>Total de Clientes</p>
                            </div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-icon success">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 id="totalContratos">0</h3>
                                <p>Contratos Ativos</p>
                            </div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 id="contratosPendentes">0</h3>
                                <p>Pendentes</p>
                            </div>
                        </div>
                        
                        <div class="kpi-card">
                            <div class="kpi-icon info">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="kpi-content">
                                <h3 id="sistemasMaisUsados">-</h3>
                                <p>Sistema Mais Usado</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Pendentes de Autorização
                            </h2>
                        </div>
                        <div class="card-content">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Código AvLock</th>
                                            <th>Sistema</th>
                                            <th>Observação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendentesTable">
                                        <tr>
                                            <td colspan="4" class="text-center" style="padding: 2rem;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                                <p style="color: var(--gray-500); margin-top: 1rem;">Carregando contratos pendentes...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Atividade Recente
                            </h2>
                        </div>
                        <div class="card-content">
                            <div id="recentActivity">
                                <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                                    Carregando atividades recentes...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clientes Page -->
                <div id="clientesPage" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-users"></i>
                                Lista de Clientes
                            </h2>
                            <button class="btn btn-primary" onclick="showModal('clienteModal'); editingId = null;">
                                <i class="fas fa-plus"></i>
                                Novo Cliente
                            </button>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <input type="text" class="form-input" id="clienteSearch" placeholder="Buscar clientes..." oninput="filterClientes()">
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nome</th>
                                            <th>Tipo</th>
                                            <th>Documento</th>
                                            <th>Email</th>
                                            <th>Telefone</th>
                                            <th>Contatos</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientesTable">
                                        <tr>
                                            <td colspan="8" class="text-center" style="padding: 2rem;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                                <p style="color: var(--gray-500); margin-top: 1rem;">Carregando clientes...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Paginação Clientes -->
                            <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem 0;">
                                <div class="pagination-info">
                                    <span id="clientesPaginationInfo">Mostrando 0 de 0 clientes</span>
                                </div>
                                <div class="pagination-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button id="clientesPrevBtn" class="btn btn-sm" onclick="changeClientesPage(-1)" disabled>
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </button>
                                    <span id="clientesPageInfo" style="padding: 0 1rem;">Página 1 de 1</span>
                                    <button id="clientesNextBtn" class="btn btn-sm" onclick="changeClientesPage(1)" disabled>
                                        Próxima <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contratos Page -->
                <div id="contratosPage" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-file-contract"></i>
                                Lista de Contratos
                            </h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="exportarContratosCSV()">
                                    <i class="fas fa-download"></i>
                                    Exportar contratos
                                </button>
                                <button class="btn btn-primary" onclick="showModal('contratoModal'); editingId = null;">
                                    <i class="fas fa-plus"></i>
                                    Novo Contrato
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" class="form-input" id="contratoSearch" placeholder="Buscar contratos..." oninput="filterContratos()">
                                </div>
                                <div class="form-group">
                                    <select class="form-select" id="statusFilter" onchange="filterContratos()">
                                        <option value="">Todos os status</option>
                                        <option value="Ativo">Ativo</option>
                                        <option value="Inativo">Inativo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID Contrato</th>
                                            <th>ID Cliente</th>
                                            <th>Nome Cliente</th>
                                            <th>Código AvLock</th>
                                            <th>Sistema</th>
                                            <th>Status</th>
                                            <th>Tipo Liberação</th>
                                            <th>Dias</th>
                                            <th>App ID</th>
                                            <th>Modalidade</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contratosTable">
                                        <tr>
                                            <td colspan="11" class="text-center" style="padding: 2rem;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                                <p style="color: var(--gray-500); margin-top: 1rem;">Carregando contratos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Paginação Contratos -->
                            <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem 0;">
                                <div class="pagination-info">
                                    <span id="contratosPaginationInfo">Mostrando 0 de 0 contratos</span>
                                </div>
                                <div class="pagination-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button id="contratosPrevBtn" class="btn btn-sm" onclick="changeContratosPage(-1)" disabled>
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </button>
                                    <span id="contratosPageInfo" style="padding: 0 1rem;">Página 1 de 1</span>
                                    <button id="contratosNextBtn" class="btn btn-sm" onclick="changeContratosPage(1)" disabled>
                                        Próxima <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chaves de Liberação Page -->
                <div id="chavesPage" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-key"></i>
                                Chaves de Liberação
                            </h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-warning" onclick="mostrarModalGeracaoChaves()">
                                    <i class="fas fa-cogs"></i>
                                    Gerar Chaves
                                </button>
                                <button class="btn btn-success" onclick="exportarChavesCSV()">
                                    <i class="fas fa-download"></i>
                                    Exportar chaves
                                </button>
                                <button class="btn btn-info" onclick="importarChavesCSV()">
                                    <i class="fas fa-upload"></i>
                                    Importar Chaves
                                </button>
                                <button class="btn btn-primary" onclick="showModal('chaveModal'); editingId = null;">
                                    <i class="fas fa-plus"></i>
                                    Nova Chave
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" class="form-input" id="chaveSearch" placeholder="Buscar por ID do contrato ou código AvLock..." oninput="filterChaves()">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-input" id="clienteChaveSearch" placeholder="Buscar por nome do cliente..." oninput="filterChaves()">
                                </div>
                                <div class="form-group">
                                    <select class="form-select" id="anoFilter" onchange="filterChaves()">
                                        <option value="">Todos os anos</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <select class="form-select" id="mesFilter" onchange="filterChaves()">
                                        <option value="">Todos os meses</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Março</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>ID Contrato</th>
                                            <th>Código AvLock</th>
                                            <th>Nome Cliente</th>
                                            <th>Ano Base</th>
                                            <th>Mês Base</th>
                                            <th>Chave AvLock</th>
                                            <th>Data Inicial</th>
                                            <th>Data Final</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="chavesTable">
                                        <tr>
                                            <td colspan="9" class="text-center" style="padding: 2rem;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                                <p style="color: var(--gray-500); margin-top: 1rem;">Carregando chaves...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Paginação Chaves -->
                            <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding: 1rem 0;">
                                <div class="pagination-info">
                                    <span id="chavesPaginationInfo">Mostrando 0 de 0 chaves</span>
                                </div>
                                <div class="pagination-controls" style="display: flex; gap: 0.5rem; align-items: center;">
                                    <button id="chavesPrevBtn" class="btn btn-sm" onclick="changeChavesPage(-1)" disabled>
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </button>
                                    <span id="chavesPageInfo" style="padding: 0 1rem;">Página 1 de 1</span>
                                    <button id="chavesNextBtn" class="btn btn-sm" onclick="changeChavesPage(1)" disabled>
                                        Próxima <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estatísticas Page -->
                <div id="estatisticasPage" class="page hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Estatísticas de Atendimento
                            </h2>
                        </div>
                        <div class="card-content">
                            <!-- Filtros -->
                            <div class="form-row" style="margin-bottom: 2rem;">
                                <div class="form-group">
                                    <label class="form-label">Ano</label>
                                    <select class="form-select" id="estatisticasAnoFilter" onchange="updateEstatisticas()">
                                        <option value="">Todos os anos</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mês</label>
                                    <select class="form-select" id="estatisticasMesFilter" onchange="updateEstatisticas()">
                                        <option value="">Todos os meses</option>
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Março</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cliente</label>
                                    <select class="form-select" id="estatisticasClienteFilter" onchange="updateEstatisticas()">
                                        <option value="">Todos os clientes</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display: flex; align-items: end;">
                                    <button class="btn btn-primary" onclick="updateEstatisticas()">
                                        <i class="fas fa-sync-alt"></i>
                                        Atualizar
                                    </button>
                                </div>
                            </div>

                            <!-- KPIs Principais -->
                            <div class="dashboard-grid" style="margin-bottom: 2rem;">
                                <div class="kpi-card">
                                    <div class="kpi-icon primary">
                                        <i class="fas fa-headset"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="totalAtendimentos">0</h3>
                                        <p>Total de Atendimentos</p>
                                    </div>
                                </div>
                                
                                <div class="kpi-card">
                                    <div class="kpi-icon success">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="mediaAtendimentosDia">0</h3>
                                        <p>Média Atendimentos/Dia</p>
                                    </div>
                                </div>
                                
                                <div class="kpi-card">
                                    <div class="kpi-icon warning">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="tempoMedioAtendimento">0h 0m</h3>
                                        <p>Tempo Médio de Atendimento</p>
                                    </div>
                                </div>
                                
                                <div class="kpi-card">
                                    <div class="kpi-icon info">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div class="kpi-content">
                                        <h3 id="notaMediaClientes">0.0</h3>
                                        <p>Nota Média dos Clientes</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Gráficos e Tabelas -->
                            <div class="form-row">
                                <!-- Top 10 Clientes -->
                                <div class="form-group" style="flex: 1;">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-trophy"></i>
                                                Top 10 Clientes (Mais Atendimentos)
                                            </h3>
                                        </div>
                                        <div class="card-content">
                                            <div class="table-container">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Posição</th>
                                                            <th>Cliente</th>
                                                            <th>Atendimentos</th>
                                                            <th>Nota Média</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="topClientesTable">
                                                        <tr>
                                                            <td colspan="4" class="text-center" style="padding: 2rem;">
                                                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                                                <p style="color: var(--gray-500); margin-top: 1rem;">Carregando dados...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Distribuição por Tipo de Atendimento -->
                                <div class="form-group" style="flex: 1;">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-chart-bar"></i>
                                                Tipos de Atendimento
                                            </h3>
                                        </div>
                                        <div class="card-content">
                                            <div class="table-container">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>Tipo</th>
                                                            <th>Quantidade</th>
                                                            <th>Percentual</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="tiposAtendimentoTable">
                                                        <tr>
                                                            <td colspan="3" class="text-center" style="padding: 2rem;">
                                                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--gray-400);"></i>
                                                                <p style="color: var(--gray-500); margin-top: 1rem;">Carregando dados...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Distribuição de Notas dos Clientes -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-star-half-alt"></i>
                                        Distribuição de Avaliações dos Clientes
                                    </h3>
                                </div>
                                <div class="card-content">
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 1;">
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">⭐ Excelente (5)</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="nota5Progress" style="width: 0%; background-color: #10b981;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="nota5Count">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">⭐ Ótimo (4)</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="nota4Progress" style="width: 0%; background-color: #3b82f6;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="nota4Count">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">⭐ Bom (3)</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="nota3Progress" style="width: 0%; background-color: #f59e0b;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="nota3Count">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">⭐ Ruim (2)</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="nota2Progress" style="width: 0%; background-color: #f97316;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="nota2Count">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">⭐ Péssimo (1)</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="nota1Progress" style="width: 0%; background-color: #ef4444;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="nota1Count">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gráfico de Atendimentos por Dia da Semana -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-calendar-week"></i>
                                        Atendimentos por Dia da Semana
                                    </h3>
                                </div>
                                <div class="card-content">
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 1;">
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Segunda-feira</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="segundaProgress" style="width: 0%; background-color: #3b82f6;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="segundaCount">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Terça-feira</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="tercaProgress" style="width: 0%; background-color: #10b981;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="tercaCount">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Quarta-feira</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="quartaProgress" style="width: 0%; background-color: #f59e0b;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="quartaCount">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Quinta-feira</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="quintaProgress" style="width: 0%; background-color: #8b5cf6;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="quintaCount">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Sexta-feira</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="sextaProgress" style="width: 0%; background-color: #f97316;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="sextaCount">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Sábado</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="sabadoProgress" style="width: 0%; background-color: #ef4444;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="sabadoCount">0</span>
                                            </div>
                                            <div class="avaliacao-item">
                                                <span class="avaliacao-label">Domingo</span>
                                                <div class="avaliacao-bar">
                                                    <div class="avaliacao-progress" id="domingoProgress" style="width: 0%; background-color: #6b7280;"></div>
                                                </div>
                                                <span class="avaliacao-count" id="domingoCount">0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Atendimentos por Atendentes -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Atendimentos por Atendentes</h5>
                                </div>
                                <div class="card-content">
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 1;" id="atendentesContainer">
                                            <!-- Os atendentes serão inseridos dinamicamente aqui -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Avaliação por Atendente -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Avaliação por Atendente</h5>
                                </div>
                                <div class="card-content">
                                    <div class="form-row">
                                        <div class="form-group" style="flex: 1;" id="avaliacaoAtendenteContainer">
                                            <!-- As médias de avaliação por atendente serão inseridas dinamicamente aqui -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

            <!-- Cliente Modal -->
            <div class="modal" id="clienteModal" role="dialog" aria-modal="true" aria-labelledby="clienteModalTitle" tabindex="-1" aria-hidden="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="clienteModalTitle">Cliente</h3>
                <button class="modal-close" onclick="hideModal('clienteModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="clienteForm">
                    <div class="modal-subtitle">Identificação</div>
                    <div class="form-group">
                        <label class="form-label">Nome *</label>
                        <input type="text" class="form-input" name="nome" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Pessoa *</label>
                            <select class="form-select" name="tipo_pessoa" onchange="toggleDocumentFields(this.value)" required>
                                <option value="">Selecione...</option>
                                <option value="F">Pessoa Física</option>
                                <option value="J">Pessoa Jurídica</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="cpfGroup">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-input" name="cpf" placeholder="000.000.000-00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group hidden" id="cnpjGroup">
                            <label class="form-label">CNPJ</label>
                            <input type="text" class="form-input" name="cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Senha</label>
                            <div class="input-with-action">
                                <input type="password" class="form-input" name="senha" placeholder="Defina a senha do cliente">
                                <button type="button" class="password-toggle" onclick="toggleSenhaVisibility(this)" title="Mostrar senha" aria-pressed="false">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="modal-subtitle">Contato</div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" name="email">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Telefone</label>
                            <input type="text" class="form-input" name="telefone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Celular</label>
                            <input type="text" class="form-input" name="celular">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contatos</label>
                        <input type="text" class="form-input" name="contatos" maxlength="200" placeholder="Nomes e contatos principais">
                    </div>

                    <div class="modal-subtitle">Endereço</div>
                    <div class="form-group">
                        <label class="form-label">Endereço</label>
                        <input type="text" class="form-input" name="endereco">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-input" name="cidade">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado (UF)</label>
                            <input type="text" class="form-input" name="uf" maxlength="2" placeholder="Ex: SP">
                        </div>
                    </div>

                    <div class="modal-subtitle">Preferências</div>
                    <div class="form-group">
                        <label class="form-label">Mensagem</label>
                        <textarea class="form-input" name="mensagem" rows="3" placeholder="Ex: Feliz Natal, Promoção especial, etc..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Visualizar Estatísticas</label>
                        <select class="form-select" name="visualizar_estatisticas">
                            <option value="S">Sim</option>
                            <option value="N">Não</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('clienteModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveCliente()">Salvar</button>
            </div>
        </div>
    </div>

            <!-- Contrato Modal -->
            <div class="modal" id="contratoModal" role="dialog" aria-modal="true" aria-labelledby="contratoModalTitle" tabindex="-1" aria-hidden="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="contratoModalTitle">Contrato</h3>
                <button class="modal-close" onclick="hideModal('contratoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="contratoForm">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select class="form-select" name="id_cliente" required>
                            <option value="">Selecione um cliente...</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Código AvLock *</label>
                            <input type="text" class="form-input" name="codigo_avlock" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sistema *</label>
                            <select class="form-select" name="sistema" required onchange="mapSistemaToAppId(this.value)">
                                <option value="">Selecione o sistema...</option>
                                <option value="SHOPCASH 6.0">SHOPCASH 6.0</option>
                                <option value="SHOPCASH 7.0">SHOPCASH 7.0</option>
                                <option value="SHOPCASH 8.0">SHOPCASH 8.0</option>
                                <option value="SHOPCASH 9.0">SHOPCASH 9.0</option>
                                <option value="SHOPCASH 10.0">SHOPCASH 10.0</option>
                                <option value="SHOPCASH 11.0">SHOPCASH 11.0</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status_liberacao">
                                <option value="Ativo">Ativo</option>
                                <option value="Inativo">Inativo</option>
                                <option value="Pendente">Pendente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo Liberação</label>
                            <select class="form-select" name="tipo_liberacao">
                                <option value="Recorrente">Recorrente</option>
                                <option value="Permanente">Permanente</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Dias de Liberação</label>
                            <input type="number" class="form-input" name="dias_liberacao" min="1" max="9999">
                        </div>
                        <div class="form-group">
                            <label class="form-label">App ID</label>
                            <select class="form-select" name="appid">
                                <option value="">Selecione o App ID...</option>
                                <option value="6398">6398</option>
                                <option value="6399">6399</option>
                                <option value="6300">6300</option>
                                <option value="6400">6400</option>
                                <option value="6500">6500</option>
                                <option value="9000">9000</option>
                                <option value="10000">10000</option>
                                <option value="11000">11000</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Modalidade</label>
                        <select class="form-select" name="modalidade">
                            <option value="">Selecione a modalidade...</option>
                            <option value="0">0 - STANDARD</option>
                            <option value="253">253 - PREMIUM</option>
                            <option value="254">254 - GOLD</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observações</label>
                        <textarea class="form-input" name="observacoes" rows="3" placeholder="Informações adicionais sobre o contrato"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('contratoModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveContrato()">Salvar</button>
            </div>
        </div>
    </div>

            <!-- Chave Modal -->
            <div class="modal" id="chaveModal" role="dialog" aria-modal="true" aria-labelledby="chaveModalTitle" tabindex="-1" aria-hidden="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="chaveModalTitle">Chave de Liberação</h3>
                <button class="modal-close" onclick="hideModal('chaveModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="chaveForm">
                    <div class="form-group">
                        <label class="form-label">ID Contrato *</label>
                        <input type="number" class="form-input" name="id_contrato" required onchange="loadContractData()">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Ano Base *</label>
                            <input type="number" class="form-input" name="ano_base" required min="2020" max="2099" onchange="updateDateSuggestions()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mês Base *</label>
                            <select class="form-select" name="mes_base" required onchange="updateDateSuggestions()">
                                <option value="">Selecione o mês...</option>
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Março</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Chave AvLock *</label>
                        <input type="text" class="form-input" name="chave_avlock" required maxlength="128">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data Inicial</label>
                            <input type="datetime-local" class="form-input" name="data_inicial">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data Final</label>
                            <input type="datetime-local" class="form-input" name="data_final">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('chaveModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="saveChave()">Salvar</button>
            </div>
        </div>
    </div>

            <!-- Modal de Seleção de Ano para Geração de Chaves -->
            <div class="modal" id="anoGeracaoModal" role="dialog" aria-modal="true" aria-labelledby="anoGeracaoModalTitle" tabindex="-1" aria-hidden="true">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="anoGeracaoModalTitle">
                    <i class="fas fa-calendar-alt"></i>
                    Selecionar Ano para Geração de Chaves
                </h3>
                <button class="modal-close" onclick="hideModal('anoGeracaoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Ano Base *</label>
                    <select class="form-select" id="anoBaseSelect" required>
                        <option value="">Selecione o ano...</option>
                    </select>
                    <small class="form-help">Selecione o ano para o qual deseja gerar as chaves de liberação</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Opções de Geração</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="opcaoGeracao" value="ano_completo" checked>
                            <span>Gerar para o ano completo (Janeiro a Dezembro)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="opcaoGeracao" value="mes_atual">
                            <span>Gerar apenas do mês atual em diante</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="opcaoGeracao" value="mes_especifico" onchange="toggleMesSelect()">
                            <span>Escolher o mês a gerar</span>
                        </label>
                    </div>
                </div>

                <div class="form-group" id="mesEspecificoGroup" style="display: none;">
                    <label class="form-label">Mês Específico</label>
                    <select class="form-select" id="mesEspecificoSelect">
                        <option value="">Selecione o mês...</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                    <small class="form-help">Selecione o mês específico para gerar as chaves</small>
                </div>

                <div class="alert alert-info" style="margin-top: 1rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Informação:</strong> Serão geradas chaves apenas para contratos com status "Ativo" que ainda não possuem chaves para o período selecionado.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('anoGeracaoModal')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarGeracaoChaves()">
                    <i class="fas fa-cogs"></i>
                    Gerar Chaves
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://ohexwiamhgsnahrjynko.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9oZXh3aWFtaGdzbmFocmp5bmtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NDM4MTcsImV4cCI6MjA3NDExOTgxN30.MYpemlbM2iYbnKWAGDWs8cbLJTKi0wK-o8P9jUDP59E';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let clientes = [];
        let contratos = [];
        let currentPage = 'dashboard';
        let editingId = null;
        // Monitor de pendentes
        let knownPendingContratoIds = new Set();
        let monitoringIntervalId = null;
        let alertsMuted = localStorage.getItem('alertsMuted') === 'true';

        // Load data from Supabase
        async function loadData() {
            if (!requireAuth()) return;
            
            try {
                // Load clientes
                const { data: clientesData, error: clientesError } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('nome');

                if (clientesError) throw clientesError;
                clientes = clientesData || [];

                // Load contratos with cliente data
                const { data: contratosData, error: contratosError } = await supabase
                    .from('contratos_itens')
                    .select(`
                        *,
                        clientes (
                            id_cliente,
                            nome,
                            tipo_pessoa
                        )
                    `)
                    .order('codigo_avlock');

                if (contratosError) throw contratosError;
                contratos = contratosData || [];

                // Update UI
                updateClienteSelect();
                renderClientes();
                renderContratos();
                updateDashboard();

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados: ' + error.message, 'error');
            }
        }

        // Update cliente select in contrato modal
        function updateClienteSelect() {
            const select = document.querySelector('#contratoForm select[name="id_cliente"]');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione um cliente...</option>';
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id_cliente;
                option.textContent = `${cliente.nome} (${cliente.tipo_pessoa === 'F' ? 'CPF' : 'CNPJ'})`;
                select.appendChild(option);
            });
        }

        // Render functions
        function renderClientes() {
            const tbody = document.getElementById('clientesTable');
            if (!tbody) return;

            if (clientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-users" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                            <p style="color: var(--gray-500);">Nenhum cliente cadastrado</p>
                        </td>
                    </tr>
                `;
                updateClientesPagination();
                return;
            }

            // Calculate pagination
            const startIndex = (clientesCurrentPage - 1) * clientesItemsPerPage;
            const endIndex = startIndex + clientesItemsPerPage;
            const paginatedClientes = clientes.slice(startIndex, endIndex);

            tbody.innerHTML = paginatedClientes.map(cliente => `
                <tr>
                    <td>${cliente.id_cliente}</td>
                    <td>${cliente.nome}</td>
                    <td>${cliente.tipo_pessoa === 'F' ? 'Física' : 'Jurídica'}</td>
                    <td>${cliente.tipo_pessoa === 'F' ? (cliente.cpf || '-') : (cliente.cnpj || '-')}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>${cliente.telefone || cliente.celular || '-'}</td>
                    <td>${cliente.contatos || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCliente(${cliente.id_cliente})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm" style="background: var(--error); color: white; margin-left: 0.5rem;" onclick="deleteCliente(${cliente.id_cliente})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update pagination controls
            updateClientesPagination();
        }

        // Função auxiliar para determinar a modalidade
        function getModalidadeText(modalidade) {
            if (modalidade === 0) return '0 - STANDARD';
            if (modalidade === 253) return '253 - PREMIUM';
            if (modalidade === 254) return '254 - GOLD';
            return modalidade ? `${modalidade}` : 'N/A';
        }

        function renderContratos() {
            const tbody = document.getElementById('contratosTable');
            if (!tbody) return;

            if (contratos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-file-contract" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                            <p style="color: var(--gray-500);">Nenhum contrato cadastrado</p>
                        </td>
                    </tr>
                `;
                updateContratosPagination();
                return;
            }

            // Calculate pagination
            const startIndex = (contratosCurrentPage - 1) * contratosItemsPerPage;
            const endIndex = startIndex + contratosItemsPerPage;
            const paginatedContratos = contratos.slice(startIndex, endIndex);

            tbody.innerHTML = paginatedContratos.map(contrato => `
                <tr>
                    <td>${contrato.id_contrato}</td>
                    <td>${contrato.id_cliente}</td>
                    <td>${contrato.clientes?.nome || 'Cliente não encontrado'}</td>
                    <td>${contrato.codigo_avlock}</td>
                    <td>${contrato.sistema}</td>
                    <td>
                        <span class="status-badge status-${contrato.status_liberacao?.toLowerCase() || 'pendente'}">
                            ${getStatusText(contrato.status_liberacao)}
                        </span>
                    </td>
                    <td>${contrato.tipo_liberacao || '-'}</td>
                    <td>${contrato.dias_liberacao || '-'}</td>
                    <td>${contrato.appid || '-'}</td>
                    <td>${getModalidadeText(contrato.modalidade)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editContrato(${contrato.id_cliente}, '${contrato.codigo_avlock}', '${contrato.sistema}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm" style="background: var(--error); color: white; margin-left: 0.5rem;" onclick="deleteContrato(${contrato.id_cliente}, '${contrato.codigo_avlock}', '${contrato.sistema}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update pagination controls
            updateContratosPagination();
        }

        // Dashboard functions
        function updateDashboard() {
            // Update KPI cards
            document.getElementById('totalClientes').textContent = clientes.length;
            document.getElementById('totalContratos').textContent = contratos.filter(c => c.status_liberacao === 'Ativo').length;
            document.getElementById('contratosPendentes').textContent = contratos.filter(c => c.status_liberacao === 'Pendente').length;

            // Update badges
            document.getElementById('clientesBadge').textContent = clientes.length;
            document.getElementById('contratosBadge').textContent = contratos.length;

            // Sistema mais usado
            const sistemas = contratos.reduce((acc, contrato) => {
                acc[contrato.sistema] = (acc[contrato.sistema] || 0) + 1;
                return acc;
            }, {});

            const sistemaMaisUsado = Object.keys(sistemas).reduce((a, b) => 
                sistemas[a] > sistemas[b] ? a : b, '-'
            );
            document.getElementById('sistemasMaisUsados').textContent = sistemaMaisUsado;

            // Update pending contracts grid
            renderPendentesContratos();

            // Update recent activity
            updateRecentActivity();
        }

        function updateRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            if (!recentActivity) return;

            const recentContratos = contratos
                .slice(-5)
                .reverse()
                .map(contrato => `
                    <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem;">
                        <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${contrato.clientes?.nome || 'Cliente não encontrado'}</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                Contrato ${contrato.codigo_avlock} - ${contrato.sistema}
                            </div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">
                            <span class="status-badge status-${contrato.status_liberacao?.toLowerCase() || 'pendente'}">
                                ${getStatusText(contrato.status_liberacao)}
                            </span>
                        </div>
                    </div>
                `).join('');

            if (recentContratos) {
                recentActivity.innerHTML = recentContratos;
            } else {
                recentActivity.innerHTML = `
                    <p class="text-center" style="color: var(--text-secondary); padding: 2rem;">
                        Nenhuma atividade recente
                    </p>
                `;
            }
        }

        // Render pending contracts grid
        function renderPendentesContratos() {
            const pendentesTable = document.getElementById('pendentesTable');
            if (!pendentesTable) return;

            const contratosPendentes = contratos.filter(c => c.status_liberacao === 'Pendente');

            if (contratosPendentes.length === 0) {
                pendentesTable.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--success);"></i>
                            <p style="color: var(--text-secondary); margin-top: 1rem;">Nenhum contrato pendente de autorização</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = contratosPendentes.map(contrato => `
                <tr>
                    <td>${contrato.clientes?.nome || 'Cliente não encontrado'}</td>
                    <td>${contrato.codigo_avlock}</td>
                    <td>${contrato.sistema}</td>
                    <td>${contrato.observacoes || '-'}</td>
                </tr>
            `).join('');

            pendentesTable.innerHTML = rows;
        }

        // Navigation functions
        function navigateTo(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[onclick="navigateTo('${page}')"]`).classList.add('active');
            
            // Load data for specific pages
            if (page === 'chaves') {
                loadChaves();
            } else if (page === 'estatisticas') {
                loadEstatisticas();
            }
            
            // Update breadcrumbs
            updateBreadcrumbs(page);
            
            currentPage = page;
        }

        function updateBreadcrumbs(page) {
            const breadcrumbs = document.getElementById('breadcrumbs');
            const pageNames = {
                'dashboard': 'Dashboard',
                'clientes': 'Clientes',
                'contratos': 'Contratos',
                'chaves': 'Chaves de Liberação',
                'estatisticas': 'Estatísticas'
            };
            
            breadcrumbs.innerHTML = `<span>${pageNames[page] || page}</span>`;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.innerHTML = newTheme === 'dark' ? 
                '<i class="fas fa-sun"></i>' : 
                '<i class="fas fa-moon"></i>';
        }

        function updateAlertToggleButton() {
            const btn = document.getElementById('alertToggle');
            if (!btn) return;
            btn.innerHTML = alertsMuted ? '<i class="fas fa-bell-slash"></i>' : '<i class="fas fa-bell"></i>';
            btn.title = alertsMuted ? 'Alertas silenciados' : 'Alertas ativos';
        }

        function toggleAlerts() {
            alertsMuted = !alertsMuted;
            localStorage.setItem('alertsMuted', alertsMuted ? 'true' : 'false');
            updateAlertToggleButton();
            showToast(alertsMuted ? 'Alertas sonoros silenciados.' : 'Alertas sonoros reativados.', 'info');
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, function(s) {
                const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
                return map[s] || s;
            });
        }

        // Modal functions
        let activeModal = null;
        let previousFocus = null;

        function getFocusableElements(container) {
            return Array.from(container.querySelectorAll(
                'a[href], area[href], input:not([disabled]):not([type="hidden"]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, [tabindex]:not([tabindex="-1"]), [contenteditable="true"]'
            )).filter(el => el.offsetParent !== null);
        }

        function trapFocus(modal) {
            const focusables = getFocusableElements(modal);
            const first = focusables[0];
            const last = focusables[focusables.length - 1];

            function onKeyDown(e) {
                if (e.key === 'Tab' && focusables.length > 0) {
                    if (e.shiftKey && document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    } else if (!e.shiftKey && document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }
            }

            modal.addEventListener('keydown', onKeyDown);
            modal.__onKeyDown = onKeyDown;
            if (first) first.focus(); else modal.focus();
        }

        function releaseFocus(modal) {
            if (modal && modal.__onKeyDown) {
                modal.removeEventListener('keydown', modal.__onKeyDown);
                delete modal.__onKeyDown;
            }
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.add('active');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            previousFocus = document.activeElement;
            activeModal = modal;
            trapFocus(modal);
            const main = document.getElementById('mainContent');
            if (main) main.setAttribute('aria-hidden', 'true');
            
            // Reset form if it's a new record
            if (!editingId) {
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // Reset document fields visibility
                if (modalId === 'clienteModal') {
                    document.getElementById('cnpjGroup').classList.add('hidden');
                    document.getElementById('cpfGroup').classList.add('hidden');
                }
                
                // Set default values for chave modal
                if (modalId === 'chaveModal') {
                    const currentYear = new Date().getFullYear();
                    const currentMonth = new Date().getMonth() + 1;
                    form.ano_base.value = currentYear;
                    form.mes_base.value = currentMonth;
                    // Automatically populate date fields with current month period
                    updateDateSuggestions();
                }
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            releaseFocus(modal);
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
            const main = document.getElementById('mainContent');
            if (main) main.setAttribute('aria-hidden', 'false');
            if (previousFocus && typeof previousFocus.focus === 'function') {
                previousFocus.focus();
            }
            activeModal = null;
            editingId = null;
        }

        // Cliente functions
        async function saveCliente() {
            if (!requireAuth()) return;
            
            const form = document.getElementById('clienteForm');
            const formData = new FormData(form);
            const clienteData = Object.fromEntries(formData.entries());
            
            // Validação básica
            if (!clienteData.nome || !clienteData.tipo_pessoa) {
                showToast('Campos obrigatórios não preenchidos', 'error');
                return;
            }
            
            // Validação de documento
            if (clienteData.tipo_pessoa === 'F' && !clienteData.cpf) {
                showToast('CPF é obrigatório para pessoa física', 'error');
                return;
            }
            
            if (clienteData.tipo_pessoa === 'J' && !clienteData.cnpj) {
                showToast('CNPJ é obrigatório para pessoa jurídica', 'error');
                return;
            }
            
            try {
                if (editingId) {
                    // Atualizar cliente existente
                    const { error } = await supabase
                        .from('clientes')
                        .update(clienteData)
                        .eq('id_cliente', editingId);
                    
                    if (error) throw error;
                    showToast('Cliente atualizado com sucesso!', 'success');
                } else {
                    // Criar novo cliente
                    const { error } = await supabase
                        .from('clientes')
                        .insert([clienteData]);
                    
                    if (error) throw error;
                    showToast('Cliente criado com sucesso!', 'success');
                }
                
                hideModal('clienteModal');
                await loadData();
                updateDashboard();
                
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                showToast('Erro ao salvar cliente: ' + error.message, 'error');
            }
        }

        async function editCliente(id) {
            const cliente = clientes.find(c => c.id_cliente === id);
            if (!cliente) return;
            
            editingId = id;
            
            // Preencher formulário
            const form = document.getElementById('clienteForm');
            Object.keys(cliente).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = cliente[key] || '';
                }
            });
            
            // Atualizar campos de documento
            toggleDocumentFields(cliente.tipo_pessoa);
            
            showModal('clienteModal');
        }

        async function deleteCliente(id) {
            if (!requireAuth()) return;
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
            
            try {
                const { error } = await supabase
                    .from('clientes')
                    .delete()
                    .eq('id_cliente', id);
                
                if (error) throw error;
                
                showToast('Cliente excluído com sucesso!', 'success');
                await loadData();
                updateDashboard();
                
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                showToast('Erro ao excluir cliente: ' + error.message, 'error');
            }
        }

        function toggleDocumentFields(tipoPessoa) {
            const cnpjGroup = document.getElementById('cnpjGroup');
            const cpfGroup = document.getElementById('cpfGroup');
            
            if (tipoPessoa === 'F') {
                cnpjGroup.classList.add('hidden');
                cpfGroup.classList.remove('hidden');
            } else {
                cnpjGroup.classList.remove('hidden');
                cpfGroup.classList.add('hidden');
            }
        }

        function toggleSenhaVisibility(button) {
            const wrapper = button.closest('.input-with-action');
            const input = wrapper ? wrapper.querySelector('input[name="senha"]') : null;
            if (!input) return;

            const isText = input.type === 'text';
            input.type = isText ? 'password' : 'text';

            const icon = button.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-eye', isText);
                icon.classList.toggle('fa-eye-slash', !isText);
            }
            button.setAttribute('aria-pressed', (!isText).toString());
            button.title = isText ? 'Mostrar senha' : 'Ocultar senha';
        }

        // Contrato functions
        async function saveContrato() {
            if (!requireAuth()) return;
            
            const form = document.getElementById('contratoForm');
            const formData = new FormData(form);
            const contratoData = Object.fromEntries(formData.entries());
            
            // Validação básica
            if (!contratoData.id_cliente || !contratoData.codigo_avlock || !contratoData.sistema) {
                showToast('Campos obrigatórios não preenchidos', 'error');
                return;
            }
            
            // Converter tipos
            contratoData.id_cliente = parseInt(contratoData.id_cliente);
            if (contratoData.appid) contratoData.appid = parseInt(contratoData.appid);
            if (contratoData.dias_liberacao) contratoData.dias_liberacao = parseInt(contratoData.dias_liberacao);
            if (contratoData.modalidade) contratoData.modalidade = parseInt(contratoData.modalidade);
            
            try {
                if (editingId) {
                    // Atualizar contrato existente
                    const [id_cliente, codigo_avlock, sistema] = editingId.split('|');
                    const { error } = await supabase
                        .from('contratos_itens')
                        .update(contratoData)
                        .eq('id_cliente', parseInt(id_cliente))
                        .eq('codigo_avlock', codigo_avlock)
                        .eq('sistema', sistema);
                    
                    if (error) throw error;
                    showToast('Contrato atualizado com sucesso!', 'success');
                } else {
                    // Criar novo contrato
                    const { error } = await supabase
                        .from('contratos_itens')
                        .insert([contratoData]);
                    
                    if (error) throw error;
                    showToast('Contrato criado com sucesso!', 'success');
                }
                
                hideModal('contratoModal');
                await loadData();
                updateDashboard();
                
            } catch (error) {
                console.error('Erro ao salvar contrato:', error);
                showToast('Erro ao salvar contrato: ' + error.message, 'error');
            }
        }

        async function editContrato(id_cliente, codigo_avlock, sistema) {
            const contrato = contratos.find(c => 
                c.id_cliente == id_cliente && 
                c.codigo_avlock === codigo_avlock && 
                c.sistema === sistema
            );
            if (!contrato) return;
            
            editingId = `${id_cliente}|${codigo_avlock}|${sistema}`;
            
            // Preencher formulário
            const form = document.getElementById('contratoForm');
            Object.keys(contrato).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input && key !== 'clientes') {
                    input.value = contrato[key] || '';
                }
            });
            
            showModal('contratoModal');
        }

        async function deleteContrato(id_cliente, codigo_avlock, sistema) {
            if (!requireAuth()) return;
            if (!confirm('Tem certeza que deseja excluir este contrato?')) return;
            
            try {
                const { error } = await supabase
                    .from('contratos_itens')
                    .delete()
                    .eq('id_cliente', parseInt(id_cliente))
                    .eq('codigo_avlock', codigo_avlock)
                    .eq('sistema', sistema);
                
                if (error) throw error;
                
                showToast('Contrato excluído com sucesso!', 'success');
                await loadData();
                updateDashboard();
                
            } catch (error) {
                console.error('Erro ao excluir contrato:', error);
                showToast('Erro ao excluir contrato: ' + error.message, 'error');
            }
        }

        // Função para mapear sistema para AppID automaticamente
        function mapSistemaToAppId(sistema) {
            const sistemaAppIdMap = {
                'SHOPCASH 11.0': '11000',
                'SHOPCASH 10.0': '10000',
                'SHOPCASH 9.0': '9000',
                'SHOPCASH 8.0': '6500',
                'SHOPCASH 7.0': '6400',
                'SHOPCASH 6.0': '6300'
            };
            
            const appIdSelect = document.querySelector('select[name="appid"]');
            if (appIdSelect && sistemaAppIdMap[sistema]) {
                appIdSelect.value = sistemaAppIdMap[sistema];
            }
        }

        // Search and filter functions
        function filterClientes() {
            const searchTerm = document.getElementById('clienteSearch')?.value.toLowerCase() || '';
            
            // Reset to first page when filtering
            clientesCurrentPage = 1;
            
            const filteredClientes = clientes.filter(cliente =>
                cliente.nome.toLowerCase().includes(searchTerm) ||
                (cliente.email && cliente.email.toLowerCase().includes(searchTerm)) ||
                (cliente.contatos && cliente.contatos.toLowerCase().includes(searchTerm)) ||
                (cliente.cnpj && cliente.cnpj.includes(searchTerm)) ||
                (cliente.cpf && cliente.cpf.includes(searchTerm))
            );
            
            renderFilteredClientes(filteredClientes);
        }

        function filterContratos() {
            const searchTerm = document.getElementById('contratoSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            
            // Reset to first page when filtering
            contratosCurrentPage = 1;
            
            let filteredContratos = contratos.filter(contrato => {
                const matchesSearch = contrato.codigo_avlock.toLowerCase().includes(searchTerm) ||
                                    contrato.sistema.toLowerCase().includes(searchTerm) ||
                                    (contrato.clientes?.nome && contrato.clientes.nome.toLowerCase().includes(searchTerm));
                
                const matchesStatus = !statusFilter || contrato.status_liberacao === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            renderFilteredContratos(filteredContratos);
        }

        function renderFilteredClientes(filteredClientes) {
            const tbody = document.getElementById('clientesTable');
            if (!tbody) return;
            
            if (filteredClientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-search" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                            <p style="color: var(--gray-500);">Nenhum cliente encontrado</p>
                        </td>
                    </tr>
                `;
                // Update pagination for empty results
                document.getElementById('clientesPaginationInfo').textContent = 'Mostrando 0 de 0 clientes';
                document.getElementById('clientesPageInfo').textContent = 'Página 0 de 0';
                document.getElementById('clientesPrevBtn').disabled = true;
                document.getElementById('clientesNextBtn').disabled = true;
                return;
            }
            
            // Calculate pagination for filtered results
            const startIndex = (clientesCurrentPage - 1) * clientesItemsPerPage;
            const endIndex = startIndex + clientesItemsPerPage;
            const paginatedClientes = filteredClientes.slice(startIndex, endIndex);
            
            tbody.innerHTML = paginatedClientes.map(cliente => `
                <tr>
                    <td>${cliente.id_cliente}</td>
                    <td>${cliente.nome}</td>
                    <td>${cliente.tipo_pessoa === 'F' ? 'Física' : 'Jurídica'}</td>
                    <td>${cliente.tipo_pessoa === 'F' ? (cliente.cpf || '-') : (cliente.cnpj || '-')}</td>
                    <td>${cliente.email || '-'}</td>
                    <td>${cliente.telefone || cliente.celular || '-'}</td>
                    <td>${cliente.contatos || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCliente(${cliente.id_cliente})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm" style="background: var(--error); color: white; margin-left: 0.5rem;" onclick="deleteCliente(${cliente.id_cliente})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update pagination for filtered results
            const totalItems = filteredClientes.length;
            const totalPages = Math.ceil(totalItems / clientesItemsPerPage);
            const startItem = (clientesCurrentPage - 1) * clientesItemsPerPage + 1;
            const endItem = Math.min(clientesCurrentPage * clientesItemsPerPage, totalItems);

            document.getElementById('clientesPaginationInfo').textContent = 
                `Mostrando ${startItem} a ${endItem} de ${totalItems} clientes`;
            document.getElementById('clientesPageInfo').textContent = 
                `Página ${clientesCurrentPage} de ${totalPages}`;

            document.getElementById('clientesPrevBtn').disabled = clientesCurrentPage === 1;
            document.getElementById('clientesNextBtn').disabled = clientesCurrentPage === totalPages || totalPages === 0;
        }

        function renderFilteredContratos(filteredContratos) {
            const tbody = document.getElementById('contratosTable');
            if (!tbody) return;
            
            if (filteredContratos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-search" style="font-size: 3rem; color: var(--gray-400); margin-bottom: 1rem;"></i>
                            <p style="color: var(--gray-500);">Nenhum contrato encontrado</p>
                        </td>
                    </tr>
                `;
                // Update pagination for empty results
                document.getElementById('contratosPaginationInfo').textContent = 'Mostrando 0 de 0 contratos';
                document.getElementById('contratosPageInfo').textContent = 'Página 0 de 0';
                document.getElementById('contratosPrevBtn').disabled = true;
                document.getElementById('contratosNextBtn').disabled = true;
                return;
            }
            
            // Calculate pagination for filtered results
            const startIndex = (contratosCurrentPage - 1) * contratosItemsPerPage;
            const endIndex = startIndex + contratosItemsPerPage;
            const paginatedContratos = filteredContratos.slice(startIndex, endIndex);
            
            tbody.innerHTML = paginatedContratos.map(contrato => `
                <tr>
                    <td>${contrato.id_contrato || '-'}</td>
                    <td>${contrato.id_cliente || '-'}</td>
                    <td>${contrato.clientes?.nome || 'Cliente não encontrado'}</td>
                    <td>${contrato.codigo_avlock}</td>
                    <td>${contrato.sistema}</td>
                    <td>
                        <span class="status-badge status-${contrato.status_liberacao?.toLowerCase() || 'pendente'}">
                            ${getStatusText(contrato.status_liberacao)}
                        </span>
                    </td>
                    <td>${contrato.tipo_liberacao || '-'}</td>
                    <td>${contrato.dias_liberacao || '-'}</td>
                    <td>${contrato.appid || '-'}</td>
                    <td>${getModalidadeText(contrato.modalidade)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editContrato(${contrato.id_cliente}, '${contrato.codigo_avlock}', '${contrato.sistema}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm" style="background: var(--error); color: white; margin-left: 0.5rem;" onclick="deleteContrato(${contrato.id_cliente}, '${contrato.codigo_avlock}', '${contrato.sistema}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update pagination for filtered results
            const totalItems = filteredContratos.length;
            const totalPages = Math.ceil(totalItems / contratosItemsPerPage);
            const startItem = (contratosCurrentPage - 1) * contratosItemsPerPage + 1;
            const endItem = Math.min(contratosCurrentPage * contratosItemsPerPage, totalItems);

            document.getElementById('contratosPaginationInfo').textContent = 
                `Mostrando ${startItem} a ${endItem} de ${totalItems} contratos`;
            document.getElementById('contratosPageInfo').textContent = 
                `Página ${contratosCurrentPage} de ${totalPages}`;

            document.getElementById('contratosPrevBtn').disabled = contratosCurrentPage === 1;
            document.getElementById('contratosNextBtn').disabled = contratosCurrentPage === totalPages || totalPages === 0;
        }

        // Monitoramento de pendentes de autorização
        async function initializePendingMonitor() {
            try {
                const atuaisPendentes = (contratos || []).filter(c => c.status_liberacao === 'Pendente');
                knownPendingContratoIds = new Set(atuaisPendentes.map(c => c.id_contrato));
                await checkForNewPendentes();
                if (monitoringIntervalId) clearInterval(monitoringIntervalId);
                monitoringIntervalId = setInterval(checkForNewPendentes, 1 * 60 * 1000);
            } catch (error) {
                console.error('Erro ao iniciar monitoramento de pendentes:', error);
            }
        }

        async function checkForNewPendentes() {
            if (!requireAuth()) return;
            try {
                const { data, error } = await supabase
                    .from('contratos_itens')
                    .select(`
                        id_contrato, id_cliente, codigo_avlock, sistema, status_liberacao,
                        clientes ( nome )
                    `)
                    .eq('status_liberacao', 'Pendente');

                if (error) {
                    console.error('Erro ao consultar pendentes:', error);
                    return;
                }
                const pendentes = data || [];
                const novos = pendentes.filter(p => !knownPendingContratoIds.has(p.id_contrato));
                if (novos.length > 0) {
                    novos.forEach(p => knownPendingContratoIds.add(p.id_contrato));
                    await loadData();
                    const detalhes = novos.map(p => {
                        const nome = escapeHtml((p.clientes && p.clientes.nome) || '-');
                        const codigo = escapeHtml(p.codigo_avlock || '-');
                        const sistema = escapeHtml(p.sistema || '-');
                        return `• ${nome} — ${codigo} (${sistema})`;
                    }).join('<br>');
                    showNotification(`<strong>Novo(s) contrato(s) pendente(s): ${novos.length}</strong><br>${detalhes}`,'warning', 12000, true);
                    try { if (!alertsMuted) playAlertSound(); } catch (e) {}
                    highlightPendentesKpi();
                }
            } catch (err) {
                console.error('Falha no monitoramento de pendentes:', err);
            }
        }

        function playAlertSound() {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;
            const ctx = new AudioCtx();
            const masterGain = ctx.createGain();
            masterGain.connect(ctx.destination);
            const now = ctx.currentTime;

            function beep(freq, start, duration, volume = 0.7) {
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                const gain = ctx.createGain();
                osc1.type = 'square';
                osc2.type = 'square';
                osc1.frequency.setValueAtTime(freq, start);
                osc2.frequency.setValueAtTime(freq * 1.02, start); // leve desafinação
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(masterGain);
                // Envelope mais incisivo
                gain.gain.setValueAtTime(0.0001, start);
                gain.gain.exponentialRampToValueAtTime(volume, start + 0.04);
                gain.gain.exponentialRampToValueAtTime(0.0001, start + Math.max(0.08, duration - 0.06));
                osc1.start(start);
                osc2.start(start);
                osc1.stop(start + duration);
                osc2.stop(start + duration);
            }

            // Padrão: dois tons repetidos (mais chamativo)
            beep(900,  now,        0.32, 0.75);
            beep(1350, now + 0.40, 0.32, 0.75);
            beep(900,  now + 0.90, 0.32, 0.75);
            beep(1350, now + 1.30, 0.32, 0.75);

            // Encerrar contexto após finalizar o padrão
            setTimeout(() => { ctx.close(); }, 1900);
        }

        function highlightPendentesKpi() {
            const el = document.getElementById('contratosPendentes');
            if (!el) return;
            const originalColor = el.style.color;
            el.style.color = '#ef4444';
            el.style.transition = 'color 0.3s ease';
            setTimeout(() => { el.style.color = originalColor || ''; }, 12000);
        }

        // Utility functions
        function getStatusText(status) {
            const statusMap = {
                'Ativo': 'Ativo',
                'Inativo': 'Inativo',
                'Pendente': 'Pendente'
            };
            return statusMap[status] || 'Desconhecido';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function formatCurrency(value) {
            if (!value) return '-';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function showToast(message, type = 'info', durationMs = 5000, sticky = false) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-${getToastIcon(type)}"></i>
                    <span>${message}</span>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove unless sticky
            if (!sticky) {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, durationMs);
            }
        }

        // Alias para showNotification usar a mesma função showToast
        function showNotification(message, type = 'info', durationMs = 5000, sticky = false) {
            showToast(message, type, durationMs, sticky);
        }

        function getToastIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Authentication guard function
        function requireAuth() {
            if (!isAuthenticated) {
                showToast('Acesso negado. Faça login para continuar.', 'error');
                showLoginScreen();
                return false;
            }
            return true;
        }

        // Authentication functions
        let isAuthenticated = false;
        let currentUser = null;

        async function login(username, password) {
            try {
                // Query the clientes table to find user with id_cliente = 1
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id_cliente, nome, senha')
                    .eq('id_cliente', 1)
                    .single();

                if (error) {
                    console.error('Erro ao buscar usuário:', error);
                    throw new Error('Erro ao conectar com o banco de dados');
                }

                if (!data) {
                    throw new Error('Usuário administrador não encontrado');
                }

                // Check if the provided password matches
                if (password !== data.senha) {
                    throw new Error('Senha incorreta');
                }

                // Check if username matches (using nome field)
                if (username !== data.nome) {
                    throw new Error('Usuário incorreto');
                }

                // Authentication successful
                isAuthenticated = true;
                currentUser = {
                    id: data.id_cliente,
                    nome: data.nome
                };

                // Store authentication in localStorage
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                return { success: true };

            } catch (error) {
                console.error('Erro no login:', error);
                return { success: false, error: error.message };
            }
        }

        function logout() {
            isAuthenticated = false;
            currentUser = null;
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        function checkAuthentication() {
            const storedAuth = localStorage.getItem('isAuthenticated');
            const storedUser = localStorage.getItem('currentUser');
            
            if (storedAuth === 'true' && storedUser) {
                isAuthenticated = true;
                currentUser = JSON.parse(storedUser);
                return true;
            }
            
            return false;
        }

        function showLoginScreen() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication first
            if (checkAuthentication()) {
                showMainApp();
                await initializeApp();
            } else {
                showLoginScreen();
            }

            // Setup login form event listener
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const username = document.getElementById('loginUsername').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    const loginBtn = document.getElementById('loginBtn');
                    
                    if (!username || !password) {
                        showLoginError('Por favor, preencha todos os campos');
                        return;
                    }
                    
                    // Show loading state
                    loginBtn.disabled = true;
                    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
                    hideLoginError();
                    
                    try {
                        const result = await login(username, password);
                        
                        if (result.success) {
                            showMainApp();
                            await initializeApp();
                            showToast('Login realizado com sucesso!', 'success');
                        } else {
                            showLoginError(result.error);
                        }
                    } catch (error) {
                        showLoginError('Erro inesperado. Tente novamente.');
                        console.error('Erro no login:', error);
                    } finally {
                        // Reset button state
                        loginBtn.disabled = false;
                        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
                    }
                });
            }
        });

        async function initializeApp() {
            // Set initial theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Update theme toggle button
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.innerHTML = savedTheme === 'dark' ? 
                    '<i class="fas fa-sun"></i>' : 
                    '<i class="fas fa-moon"></i>';
            }
            
            // Update user info in header
            const currentUserNameElement = document.getElementById('currentUserName');
            if (currentUserNameElement && currentUser) {
                currentUserNameElement.textContent = `Olá, ${currentUser.nome}`;
            }
            
            // Load initial data
            await loadData();
            await loadChaves();
            
            // Navigate to dashboard
            navigateTo('dashboard');
            
            // Iniciar monitoramento de pendentes
            await initializePendingMonitor();

            // Configurar botão de silenciar/reativar alertas
            updateAlertToggleButton();
            const alertToggleBtn = document.getElementById('alertToggle');
            if (alertToggleBtn) {
                alertToggleBtn.addEventListener('click', toggleAlerts);
            }
            
            // Setup event listeners
            // Setup sidebar toggle
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Event listeners para filtros de estatísticas
            const estatisticasAnoFilter = document.getElementById('estatisticasAnoFilter');
            const estatisticasMesFilter = document.getElementById('estatisticasMesFilter');
            const estatisticasClienteFilter = document.getElementById('estatisticasClienteFilter');
            
            if (estatisticasAnoFilter) {
                estatisticasAnoFilter.addEventListener('change', updateEstatisticas);
            }
            
            if (estatisticasMesFilter) {
                estatisticasMesFilter.addEventListener('change', updateEstatisticas);
            }
            
            if (estatisticasClienteFilter) {
                estatisticasClienteFilter.addEventListener('change', updateEstatisticas);
            }
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('active') &&
                !sidebar.contains(e.target) && 
                !sidebarToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        // Pagination variables
        let clientesCurrentPage = 1;
        let clientesItemsPerPage = 10;
        let contratosCurrentPage = 1;
        let contratosItemsPerPage = 10;

        // Pagination functions for Clientes
        function changeClientesPage(direction) {
            const totalPages = Math.ceil(clientes.length / clientesItemsPerPage);
            const newPage = clientesCurrentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                clientesCurrentPage = newPage;
                renderClientes();
            }
        }

        function updateClientesPagination() {
            const totalItems = clientes.length;
            const totalPages = Math.ceil(totalItems / clientesItemsPerPage);
            const startItem = (clientesCurrentPage - 1) * clientesItemsPerPage + 1;
            const endItem = Math.min(clientesCurrentPage * clientesItemsPerPage, totalItems);

            // Update pagination info
            document.getElementById('clientesPaginationInfo').textContent = 
                `Mostrando ${startItem} a ${endItem} de ${totalItems} clientes`;
            document.getElementById('clientesPageInfo').textContent = 
                `Página ${clientesCurrentPage} de ${totalPages}`;

            // Update button states
            document.getElementById('clientesPrevBtn').disabled = clientesCurrentPage === 1;
            document.getElementById('clientesNextBtn').disabled = clientesCurrentPage === totalPages || totalPages === 0;
        }

        // Pagination functions for Contratos
        function changeContratosPage(direction) {
            const totalPages = Math.ceil(contratos.length / contratosItemsPerPage);
            const newPage = contratosCurrentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                contratosCurrentPage = newPage;
                renderContratos();
            }
        }

        function updateContratosPagination() {
            const totalItems = contratos.length;
            const totalPages = Math.ceil(totalItems / contratosItemsPerPage);
            const startItem = (contratosCurrentPage - 1) * contratosItemsPerPage + 1;
            const endItem = Math.min(contratosCurrentPage * contratosItemsPerPage, totalItems);

            // Update pagination info
            document.getElementById('contratosPaginationInfo').textContent = 
                `Mostrando ${startItem} a ${endItem} de ${totalItems} contratos`;
            document.getElementById('contratosPageInfo').textContent = 
                `Página ${contratosCurrentPage} de ${totalPages}`;

            // Update button states
            document.getElementById('contratosPrevBtn').disabled = contratosCurrentPage === 1;
            document.getElementById('contratosNextBtn').disabled = contratosCurrentPage === totalPages || totalPages === 0;
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
            }
        });

        // Evitar fechamento ao clicar fora: não fechar modais pelo overlay
        // Removido listener que fechava ao clicar no fundo

        // Register service worker for PWA
        
        // Chaves functions
        let chaves = [];
        let currentChavesPage = 1;
        const chavesPerPage = 10;

        async function loadChaves() {
            try {
                const { data: chavesData, error: chavesError } = await supabase
                    .from('contratos_chaves')
                    .select(`
                        *,
                        contratos_itens(
                            codigo_avlock,
                            clientes(
                                nome
                            )
                        )
                    `)
                    .order('id_contrato');

                if (chavesError) throw chavesError;
                chaves = chavesData || [];

                renderChaves();
                updateChavesBadge();
                populateAnoFilter();

            } catch (error) {
                console.error('Erro ao carregar chaves:', error);
                showToast('Erro ao carregar chaves: ' + error.message, 'error');
            }
        }

        function renderChaves() {
            const tbody = document.getElementById('chavesTable');
            if (!tbody) return;

            if (chaves.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-key" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p style="color: var(--gray-500); margin-top: 1rem;">Nenhuma chave encontrada</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const startIndex = (currentChavesPage - 1) * chavesPerPage;
            const endIndex = startIndex + chavesPerPage;
            const pageChaves = chaves.slice(startIndex, endIndex);

            tbody.innerHTML = pageChaves.map(chave => `
                <tr>
                    <td>${chave.id_contrato}</td>
                    <td>${chave.contratos_itens?.codigo_avlock || '-'}</td>
                    <td>${chave.contratos_itens?.clientes?.nome || '-'}</td>
                    <td>${chave.ano_base}</td>
                    <td>${getMonthName(chave.mes_base)}</td>
                    <td>${chave.chave_avlock}</td>
                    <td>${chave.data_inicial ? formatDateTime(chave.data_inicial) : '-'}</td>
                    <td>${chave.data_final ? formatDateTime(chave.data_final) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editChave(${chave.id_chave})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteChave(${chave.id_chave})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            updateChavesPagination();
        }

        function updateChavesBadge() {
            const badge = document.getElementById('chavesBadge');
            if (badge) {
                badge.textContent = chaves.length;
            }
        }

        function populateAnoFilter() {
            const anoFilter = document.getElementById('anoFilter');
            if (!anoFilter) return;

            const anos = [...new Set(chaves.map(c => c.ano_base))].sort((a, b) => b - a);
            
            anoFilter.innerHTML = '<option value="">Todos os anos</option>';
            anos.forEach(ano => {
                anoFilter.innerHTML += `<option value="${ano}">${ano}</option>`;
            });
        }

        function getMonthName(month) {
            const months = [
                '', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return months[month] || month;
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        function filterChaves() {
            const searchTerm = document.getElementById('chaveSearch')?.value.toLowerCase() || '';
            const clienteSearchTerm = document.getElementById('clienteChaveSearch')?.value.toLowerCase() || '';
            const anoFilter = document.getElementById('anoFilter')?.value || '';
            const mesFilter = document.getElementById('mesFilter')?.value || '';

            let filteredChaves = chaves.filter(chave => {
                const matchesSearch = 
                    chave.id_contrato.toString().includes(searchTerm) ||
                    (chave.contratos_itens?.codigo_avlock && 
                     chave.contratos_itens.codigo_avlock.toLowerCase().includes(searchTerm));
                
                const matchesCliente = !clienteSearchTerm || 
                    (chave.contratos_itens?.clientes?.nome && 
                     chave.contratos_itens.clientes.nome.toLowerCase().includes(clienteSearchTerm));
                
                const matchesAno = !anoFilter || chave.ano_base.toString() === anoFilter;
                const matchesMes = !mesFilter || chave.mes_base.toString() === mesFilter;

                return matchesSearch && matchesCliente && matchesAno && matchesMes;
            });

            // Reset pagination when filtering
            currentChavesPage = 1;
            renderFilteredChaves(filteredChaves);
        }

        function renderFilteredChaves(filteredChaves) {
            const tbody = document.getElementById('chavesTable');
            if (!tbody) return;

            if (filteredChaves.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-search" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p style="color: var(--gray-500); margin-top: 1rem;">Nenhuma chave encontrada com os filtros aplicados</p>
                        </td>
                    </tr>
                `;
                document.getElementById('chavesPaginationInfo').textContent = 'Mostrando 0 de 0 chaves';
                document.getElementById('chavesPageInfo').textContent = 'Página 0 de 0';
                document.getElementById('chavesPrevBtn').disabled = true;
                document.getElementById('chavesNextBtn').disabled = true;
                return;
            }

            const startIndex = (currentChavesPage - 1) * chavesPerPage;
            const endIndex = startIndex + chavesPerPage;
            const pageChaves = filteredChaves.slice(startIndex, endIndex);

            tbody.innerHTML = pageChaves.map(chave => `
                <tr>
                    <td>${chave.id_contrato}</td>
                    <td>${chave.contratos_itens?.codigo_avlock || '-'}</td>
                    <td>${chave.contratos_itens?.clientes?.nome || '-'}</td>
                    <td>${chave.ano_base}</td>
                    <td>${getMonthName(chave.mes_base)}</td>
                    <td>${chave.chave_avlock}</td>
                    <td>${chave.data_inicial ? formatDateTime(chave.data_inicial) : '-'}</td>
                    <td>${chave.data_final ? formatDateTime(chave.data_final) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editChave(${chave.id_chave})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteChave(${chave.id_chave})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Update pagination for filtered results
            const totalFiltered = filteredChaves.length;
            const totalPages = Math.ceil(totalFiltered / chavesPerPage);
            const startItem = startIndex + 1;
            const endItem = Math.min(endIndex, totalFiltered);
            
            document.getElementById('chavesPaginationInfo').textContent = 
                `Mostrando ${startItem} a ${endItem} de ${totalFiltered} chaves`;
            document.getElementById('chavesPageInfo').textContent = `Página ${currentChavesPage} de ${totalPages}`;
            
            document.getElementById('chavesPrevBtn').disabled = currentChavesPage === 1;
            document.getElementById('chavesNextBtn').disabled = currentChavesPage === totalPages || totalPages === 0;
        }

        function updateChavesPagination() {
            const totalPages = Math.ceil(chaves.length / chavesPerPage);
            const startItem = (currentChavesPage - 1) * chavesPerPage + 1;
            const endItem = Math.min(currentChavesPage * chavesPerPage, chaves.length);

            document.getElementById('chavesPageInfo').textContent = `Página ${currentChavesPage} de ${totalPages}`;
            document.getElementById('chavesPaginationInfo').textContent = `Mostrando ${startItem} a ${endItem} de ${chaves.length} chaves`;

            document.getElementById('chavesPrevBtn').disabled = currentChavesPage === 1;
            document.getElementById('chavesNextBtn').disabled = currentChavesPage === totalPages;
        }

        function changeChavesPage(direction) {
            const totalPages = Math.ceil(chaves.length / chavesPerPage);
            
            if (direction === 1 && currentChavesPage < totalPages) {
                currentChavesPage++;
            } else if (direction === -1 && currentChavesPage > 1) {
                currentChavesPage--;
            }

            renderChaves();
        }

        function updateDateSuggestions() {
            const anoBase = document.querySelector('input[name="ano_base"]').value;
            const mesBase = document.querySelector('select[name="mes_base"]').value;
            
            if (anoBase && mesBase) {
                const year = parseInt(anoBase);
                const month = parseInt(mesBase);
                
                // Primeiro dia do mês
                const firstDay = new Date(year, month - 1, 1);
                
                // Formatar para datetime-local (YYYY-MM-DDTHH:MM)
                const formatDateTime = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}T00:00`;
                };
                
                const formatDateTimeEnd = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}T23:59`;
                };
                
                // Atualizar campo de data inicial
                document.querySelector('input[name="data_inicial"]').value = formatDateTime(firstDay);
                
                // Calcular data final baseada em dias_liberacao se disponível
                let finalDate;
                if (currentContractData && currentContractData.dias_liberacao) {
                    // Data final = data inicial + dias_liberacao
                    finalDate = new Date(firstDay);
                    finalDate.setDate(finalDate.getDate() + currentContractData.dias_liberacao - 1); // -1 porque o primeiro dia já conta
                } else {
                    // Fallback para último dia do mês se não houver dados do contrato
                    finalDate = new Date(year, month, 0);
                }
                
                document.querySelector('input[name="data_final"]').value = formatDateTimeEnd(finalDate);
            }
        }

        // Global variable to store contract data
        let currentContractData = null;

        async function loadContractData() {
            const idContrato = document.querySelector('input[name="id_contrato"]').value;
            
            if (idContrato) {
                try {
                    const { data, error } = await supabase
                        .from('contratos_itens')
                        .select('dias_liberacao')
                        .eq('id_contrato', parseInt(idContrato))
                        .single();
                    
                    if (error) {
                        console.log('Contrato não encontrado ou erro:', error);
                        currentContractData = null;
                    } else {
                        currentContractData = data;
                        // Update date suggestions when contract data is loaded
                        updateDateSuggestions();
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados do contrato:', error);
                    currentContractData = null;
                }
            } else {
                currentContractData = null;
            }
        }

        async function saveChave() {
            const form = document.getElementById('chaveForm');
            const formData = new FormData(form);
            
            const chaveData = {
                id_contrato: parseInt(formData.get('id_contrato')),
                ano_base: parseInt(formData.get('ano_base')),
                mes_base: parseInt(formData.get('mes_base')),
                chave_avlock: formData.get('chave_avlock'),
                data_inicial: formData.get('data_inicial') || null,
                data_final: formData.get('data_final') || null
            };

            try {
                let result;
                if (editingId) {
                    result = await supabase
                        .from('contratos_chaves')
                        .update(chaveData)
                        .eq('id_chave', editingId);
                } else {
                    result = await supabase
                        .from('contratos_chaves')
                        .insert([chaveData]);
                }

                if (result.error) throw result.error;

                showToast(editingId ? 'Chave atualizada com sucesso!' : 'Chave criada com sucesso!', 'success');
                hideModal('chaveModal');
                form.reset();
                await loadChaves();

            } catch (error) {
                console.error('Erro ao salvar chave:', error);
                showToast('Erro ao salvar chave: ' + error.message, 'error');
            }
        }

        async function editChave(id) {
            const chave = chaves.find(c => c.id_chave === id);
            if (!chave) return;

            editingId = id;
            
            const form = document.getElementById('chaveForm');
            form.id_contrato.value = chave.id_contrato;
            form.ano_base.value = chave.ano_base;
            form.mes_base.value = chave.mes_base;
            form.chave_avlock.value = chave.chave_avlock;
            
            if (chave.data_inicial) {
                form.data_inicial.value = new Date(chave.data_inicial).toISOString().slice(0, 16);
            }
            if (chave.data_final) {
                form.data_final.value = new Date(chave.data_final).toISOString().slice(0, 16);
            }

            showModal('chaveModal');
        }

        async function deleteChave(id) {
            if (!confirm('Tem certeza que deseja excluir esta chave?')) return;

            try {
                const { error } = await supabase
                    .from('contratos_chaves')
                    .delete()
                    .eq('id_chave', id);

                if (error) throw error;

                showToast('Chave excluída com sucesso!', 'success');
                await loadChaves();

            } catch (error) {
                console.error('Erro ao excluir chave:', error);
                showToast('Erro ao excluir chave: ' + error.message, 'error');
            }
        }

        // Função para exportar contratos para CSV
        function exportarContratosCSV() {
            const nomeArquivo = prompt('Digite o nome do arquivo (sem extensão):', 'contratos_export');
            
            if (!nomeArquivo) {
                return; // Usuário cancelou
            }

            // Obter dados dos contratos (usar dados filtrados se houver filtro ativo)
            let dadosParaExportar = contratos;
            
            // Verificar se há filtros ativos
            const searchTerm = document.getElementById('contratoSearch')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            
            if (searchTerm || statusFilter) {
                dadosParaExportar = contratos.filter(contrato => {
                    const matchesSearch = !searchTerm || 
                        contrato.clientes?.nome?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        contrato.codigo_avlock?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        contrato.sistema?.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    const matchesStatus = !statusFilter || contrato.status_liberacao === statusFilter;
                    
                    return matchesSearch && matchesStatus;
                });
            }

            if (dadosParaExportar.length === 0) {
                showToast('Nenhum contrato encontrado para exportar', 'warning');
                return;
            }

            // Criar cabeçalho CSV
            const cabecalho = [
                'ID Contrato',
                'ID Cliente', 
                'Nome Cliente',
                'Código AvLock',
                'Sistema',
                'Status',
                'Tipo Liberação',
                'Dias',
                'App ID'
            ];

            // Converter dados para CSV
            const linhasCSV = dadosParaExportar.map(contrato => [
                contrato.id_contrato || '',
                contrato.id_cliente || '',
                contrato.clientes?.nome || '',
                contrato.codigo_avlock || '',
                contrato.sistema || '',
                getStatusText(contrato.status_liberacao) || '',
                contrato.tipo_liberacao || '',
                contrato.dias_liberacao || '',
                contrato.appid || ''
            ]);

            // Combinar cabeçalho e dados
            const csvContent = [cabecalho, ...linhasCSV]
                .map(linha => linha.map(campo => `"${campo}"`).join(','))
                .join('\n');

            // Criar e baixar arquivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${nomeArquivo}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`Arquivo ${nomeArquivo}.csv exportado com sucesso!`, 'success');
            } else {
                showToast('Seu navegador não suporta download de arquivos', 'error');
            }
        }

        // Função para gerar chaves baseada nos contratos_itens
        // Função para mostrar modal de seleção de ano
        function mostrarModalGeracaoChaves() {
            // Preencher select com anos (ano atual - 2 até ano atual + 5)
            const anoAtual = new Date().getFullYear();
            const selectAno = document.getElementById('anoBaseSelect');
            selectAno.innerHTML = '<option value="">Selecione o ano...</option>';
            
            for (let ano = anoAtual - 2; ano <= anoAtual + 5; ano++) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                if (ano === anoAtual) {
                    option.selected = true;
                }
                selectAno.appendChild(option);
            }
            
            showModal('anoGeracaoModal');
        }

        // Função para mostrar/ocultar o select de mês específico
        function toggleMesSelect() {
            const mesEspecificoGroup = document.getElementById('mesEspecificoGroup');
            const opcaoSelecionada = document.querySelector('input[name="opcaoGeracao"]:checked').value;
            
            if (opcaoSelecionada === 'mes_especifico') {
                mesEspecificoGroup.style.display = 'block';
            } else {
                mesEspecificoGroup.style.display = 'none';
            }
        }

        // Função para confirmar e executar geração de chaves
        async function confirmarGeracaoChaves() {
            const anoSelecionado = document.getElementById('anoBaseSelect').value;
            const opcaoGeracao = document.querySelector('input[name="opcaoGeracao"]:checked').value;
            
            if (!anoSelecionado) {
                showToast('Por favor, selecione um ano', 'warning');
                return;
            }
            
            let mesInicial, mesFinal;
            
            if (opcaoGeracao === 'ano_completo') {
                mesInicial = 1;
                mesFinal = 12;
            } else if (opcaoGeracao === 'mes_atual') {
                mesInicial = new Date().getMonth() + 1;
                mesFinal = 12;
            } else if (opcaoGeracao === 'mes_especifico') {
                const mesEspecifico = document.getElementById('mesEspecificoSelect').value;
                if (!mesEspecifico) {
                    showToast('Por favor, selecione um mês específico', 'warning');
                    return;
                }
                mesInicial = parseInt(mesEspecifico);
                mesFinal = parseInt(mesEspecifico);
            }
            
            hideModal('anoGeracaoModal');
            
            const anoInt = parseInt(anoSelecionado);
            await gerarChaves(anoInt, mesInicial, mesFinal);
        }

        async function gerarChaves(anoBase = null, mesInicial = null, mesFinal = null) {
            try {
                // Se não foram passados parâmetros, usar valores padrão (comportamento antigo)
                const anoCorrente = anoBase || new Date().getFullYear();
                const mesCorrente = mesInicial || (new Date().getMonth() + 1);
                const mesFinalCorrente = mesFinal || 12;

                showToast('Gerando chaves...', 'info');

                // Buscar todos os contratos_itens ativos
                const { data: contratosItens, error: contratosError } = await supabase
                    .from('contratos_itens')
                    .select('*')
                    .eq('status_liberacao', 'Ativo');

                if (contratosError) {
                    throw new Error('Erro ao buscar contratos: ' + contratosError.message);
                }

                if (!contratosItens || contratosItens.length === 0) {
                    showToast('Nenhum contrato ativo encontrado para gerar chaves', 'warning');
                    return;
                }

                let chavesGeradas = 0;
                let erros = 0;

                // Para cada contrato_item, gerar chaves para os meses do ano selecionado
                for (const contrato of contratosItens) {
                    for (let mes = mesCorrente; mes <= mesFinalCorrente; mes++) {
                        try {
                            // Verificar se já existe uma chave para este contrato, ano e mês
                            const { data: chaveExistente, error: checkError } = await supabase
                                .from('contratos_chaves')
                                .select('id_chave')
                                .eq('id_contrato', contrato.id_contrato)
                                .eq('ano_base', anoCorrente)
                                .eq('mes_base', mes)
                                .single();

                            if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = no rows found
                                console.error('Erro ao verificar chave existente:', checkError);
                                continue;
                            }

                            // Se já existe, pular
                            if (chaveExistente) {
                                continue;
                            }

                            // Calcular data inicial (primeiro dia do mês)
                            const dataInicial = new Date(anoCorrente, mes - 1, 1); // mes - 1 porque JavaScript months são 0-based
                            
                            // Calcular data final baseada na data inicial + dias_liberacao
                            const dataFinal = new Date(dataInicial);
                            dataFinal.setDate(dataInicial.getDate() + contrato.dias_liberacao);

                            // Inserir nova chave
                            const { error: insertError } = await supabase
                                .from('contratos_chaves')
                                .insert({
                                    id_contrato: contrato.id_contrato,
                                    ano_base: anoCorrente,
                                    mes_base: mes,
                                    chave_avlock: '', // Chave vazia inicialmente
                                    data_inicial: dataInicial.toISOString(),
                                    data_final: dataFinal.toISOString()
                                });

                            if (insertError) {
                                console.error('Erro ao inserir chave:', insertError);
                                erros++;
                            } else {
                                chavesGeradas++;
                            }

                        } catch (error) {
                            console.error('Erro ao processar chave:', error);
                            erros++;
                        }
                    }
                }

                // Recarregar dados das chaves
                await loadChaves();

                // Mostrar resultado
                if (chavesGeradas > 0) {
                    showToast(`${chavesGeradas} chaves geradas com sucesso para o ano ${anoCorrente}!${erros > 0 ? ` (${erros} erros)` : ''}`, 'success');
                } else if (erros > 0) {
                    showToast(`Erro ao gerar chaves. ${erros} erros encontrados.`, 'error');
                } else {
                    showToast(`Todas as chaves já existem para o período selecionado do ano ${anoCorrente}`, 'info');
                }

            } catch (error) {
                console.error('Erro ao gerar chaves:', error);
                showToast('Erro ao gerar chaves: ' + error.message, 'error');
            }
        }

        // Função para exportar chaves para CSV
        async function exportarChavesCSV() {
            try {
                // Solicitar nome do arquivo ao usuário
                const nomeArquivo = prompt('Digite o nome do arquivo (sem extensão):');
                if (!nomeArquivo) {
                    return; // Usuário cancelou
                }

                showToast('Preparando exportação...', 'info');

                // Obter dados filtrados das chaves (respeitando filtros ativos)
                const searchTerm = document.getElementById('chaveSearch')?.value.toLowerCase() || '';
                const clienteSearchTerm = document.getElementById('clienteChaveSearch')?.value.toLowerCase() || '';
                const anoFilter = document.getElementById('anoFilter')?.value || '';
                const mesFilter = document.getElementById('mesFilter')?.value || '';

                let dadosParaExportar = chaves.filter(chave => {
                    const matchesSearch = 
                        chave.id_contrato.toString().includes(searchTerm);
                    
                    const matchesCliente = !clienteSearchTerm || 
                        (chave.contratos_itens?.clientes?.nome && 
                         chave.contratos_itens.clientes.nome.toLowerCase().includes(clienteSearchTerm)) ||
                        (chave.contratos_itens?.codigo_avlock && 
                         chave.contratos_itens.codigo_avlock.toLowerCase().includes(clienteSearchTerm));
                    
                    const matchesAno = !anoFilter || chave.ano_base.toString() === anoFilter;
                    const matchesMes = !mesFilter || chave.mes_base.toString() === mesFilter;

                    return matchesSearch && matchesCliente && matchesAno && matchesMes;
                });

                if (dadosParaExportar.length === 0) {
                    showToast('Nenhuma chave encontrada para exportar', 'warning');
                    return;
                }

                // Buscar dados adicionais dos contratos_itens para cada chave
                const chavesComDadosCompletos = [];
                
                for (const chave of dadosParaExportar) {
                    try {
                        // Buscar dados completos do contrato_item
                        const { data: contratoData, error: contratoError } = await supabase
                            .from('contratos_itens')
                            .select('codigo_avlock, dias_liberacao, tipo_liberacao, status_liberacao, appid, modalidade')
                            .eq('id_contrato', chave.id_contrato)
                            .single();

                        if (contratoError) {
                            console.error('Erro ao buscar dados do contrato:', contratoError);
                            // Usar dados parciais se houver erro
                            chavesComDadosCompletos.push({
                                ...chave,
                                codigo_avlock: chave.contratos_itens?.codigo_avlock || '',
                                dias_liberacao: '',
                                tipo_liberacao: '',
                                status_liberacao: '',
                                appid: '',
                                modalidade: ''
                            });
                        } else {
                            chavesComDadosCompletos.push({
                                ...chave,
                                codigo_avlock: contratoData.codigo_avlock || '',
                                dias_liberacao: contratoData.dias_liberacao || '',
                                tipo_liberacao: contratoData.tipo_liberacao || '',
                                status_liberacao: contratoData.status_liberacao || '',
                                appid: contratoData.appid || '',
                                modalidade: contratoData.modalidade || ''
                            });
                        }
                    } catch (error) {
                        console.error('Erro ao processar chave:', error);
                        // Adicionar com dados parciais em caso de erro
                        chavesComDadosCompletos.push({
                            ...chave,
                            codigo_avlock: chave.contratos_itens?.codigo_avlock || '',
                            dias_liberacao: '',
                            tipo_liberacao: '',
                            status_liberacao: '',
                            appid: '',
                            modalidade: ''
                        });
                    }
                }

                // Definir cabeçalho do CSV com os campos solicitados
                const cabecalho = [
                    'ID Chave',
                    'Chave AvLock',
                    'Código AvLock',
                    'Dias Liberação',
                    'Tipo Liberação',
                    'Status Liberação',
                    'App ID',
                    'Modalidade',
                    'Data Inicial'
                ];

                // Converter dados para CSV
                const linhasCSV = chavesComDadosCompletos.map(chave => [
                    chave.id_chave || '',
                    chave.chave_avlock || '',
                    chave.codigo_avlock || '',
                    chave.dias_liberacao || '',
                    chave.tipo_liberacao || '',
                    chave.status_liberacao || '',
                    chave.appid || '',
                    chave.modalidade || '',
                    chave.data_inicial ? new Date(chave.data_inicial).toLocaleDateString('pt-BR') : ''
                ]);

                // Combinar cabeçalho e dados
                const csvContent = [cabecalho, ...linhasCSV]
                    .map(linha => linha.map(campo => `"${campo}"`).join(','))
                    .join('\n');

                // Criar e baixar arquivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `${nomeArquivo}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast(`Arquivo ${nomeArquivo}.csv exportado com sucesso! (${chavesComDadosCompletos.length} registros)`, 'success');
                } else {
                    showToast('Seu navegador não suporta download de arquivos', 'error');
                }

            } catch (error) {
                console.error('Erro ao exportar chaves:', error);
                showToast('Erro ao exportar chaves: ' + error.message, 'error');
            }
        }

        // Função para importar chaves de arquivo CSV
        async function importarChavesCSV() {
            try {
                // Criar input file para seleção do arquivo
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.csv';
                input.style.display = 'none';
                
                // Adicionar evento para processar o arquivo selecionado
                input.addEventListener('change', async function(event) {
                    const file = event.target.files[0];
                    if (!file) {
                        return;
                    }

                    // Verificar se é um arquivo CSV
                    if (!file.name.toLowerCase().endsWith('.csv')) {
                        showToast('Por favor, selecione um arquivo CSV válido', 'error');
                        return;
                    }

                    showToast('Processando arquivo CSV...', 'info');

                    try {
                        // Ler o conteúdo do arquivo
                        const text = await file.text();
                        const lines = text.split('\n').filter(line => line.trim() !== '');
                        
                        if (lines.length === 0) {
                            showToast('Arquivo CSV está vazio', 'warning');
                            return;
                        }

                        // Processar cada linha do CSV
                        const updates = [];
                        let processedCount = 0;
                        let errorCount = 0;

                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;

                            // Dividir a linha por vírgula e remover aspas
                            const columns = line.split(',').map(col => col.replace(/"/g, '').trim());
                            
                            if (columns.length < 2) {
                                console.warn(`Linha ${i + 1} ignorada: formato inválido`);
                                errorCount++;
                                continue;
                            }

                            const idChave = columns[0];
                            const chaveAvlock = columns[1];

                            // Validar se id_chave é um número válido
                            if (!idChave || isNaN(parseInt(idChave))) {
                                console.warn(`Linha ${i + 1} ignorada: ID da chave inválido`);
                                errorCount++;
                                continue;
                            }

                            updates.push({
                                id_chave: parseInt(idChave),
                                chave_avlock: chaveAvlock
                            });
                        }

                        if (updates.length === 0) {
                            showToast('Nenhum registro válido encontrado no arquivo CSV', 'warning');
                            return;
                        }

                        // Confirmar com o usuário antes de prosseguir
                        const confirmMessage = `Foram encontrados ${updates.length} registros válidos para atualização.\n${errorCount > 0 ? `${errorCount} linhas foram ignoradas por formato inválido.\n` : ''}Deseja continuar com a importação?`;
                        
                        if (!confirm(confirmMessage)) {
                            return;
                        }

                        // Processar atualizações no banco de dados
                        let successCount = 0;
                        let failCount = 0;

                        for (const update of updates) {
                            try {
                                const { error } = await supabase
                                    .from('contratos_chaves')
                                    .update({ chave_avlock: update.chave_avlock })
                                    .eq('id_chave', update.id_chave);

                                if (error) {
                                    console.error(`Erro ao atualizar chave ${update.id_chave}:`, error);
                                    failCount++;
                                } else {
                                    successCount++;
                                }
                            } catch (error) {
                                console.error(`Erro ao processar chave ${update.id_chave}:`, error);
                                failCount++;
                            }
                        }

                        // Exibir resultado da importação
                        if (successCount > 0) {
                            showToast(`Importação concluída! ${successCount} chaves atualizadas com sucesso.${failCount > 0 ? ` ${failCount} falharam.` : ''}`, 'success');
                            
                            // Recarregar os dados das chaves
                            await loadChaves();
                        } else {
                            showToast('Nenhuma chave foi atualizada. Verifique os IDs no arquivo CSV.', 'warning');
                        }

                    } catch (error) {
                        console.error('Erro ao processar arquivo CSV:', error);
                        showToast('Erro ao processar arquivo CSV: ' + error.message, 'error');
                    }
                });

                // Adicionar input ao DOM e simular clique
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);

            } catch (error) {
                console.error('Erro ao importar chaves:', error);
                showToast('Erro ao importar chaves: ' + error.message, 'error');
            }
        }

        // Funções para Estatísticas
        async function loadEstatisticas() {
            try {
                // Carregar filtros
                await loadEstatisticasFilters();
                
                // Carregar estatísticas
                await updateEstatisticas();
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
                showNotification('Erro ao carregar estatísticas', 'error');
            }
        }

        async function loadEstatisticasFilters() {
            try {
                // Carregar anos disponíveis
                const { data: anos, error: anosError } = await supabase
                    .from('clientes_atendimentos')
                    .select('solicitado_em')
                    .not('solicitado_em', 'is', null);

                if (anosError) throw anosError;

                const anosUnicos = [...new Set(anos.map(item => 
                    new Date(item.solicitado_em).getFullYear()
                ))].sort((a, b) => b - a);

                const anoSelect = document.getElementById('estatisticasAnoFilter');
                anoSelect.innerHTML = '<option value="">Todos os anos</option>';
                anosUnicos.forEach(ano => {
                    anoSelect.innerHTML += `<option value="${ano}">${ano}</option>`;
                });

                // Carregar clientes
                const { data: clientes, error: clientesError } = await supabase
                    .from('clientes')
                    .select('id_cliente, nome')
                    .order('nome');

                if (clientesError) throw clientesError;

                const clienteSelect = document.getElementById('estatisticasClienteFilter');
                clienteSelect.innerHTML = '<option value="">Todos os clientes</option>';
                clientes.forEach(cliente => {
                    clienteSelect.innerHTML += `<option value="${cliente.id_cliente}">${cliente.nome}</option>`;
                });

            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
            }
        }

        async function updateEstatisticas() {
            try {
                const anoFilter = document.getElementById('estatisticasAnoFilter').value;
                const mesFilter = document.getElementById('estatisticasMesFilter').value;
                const clienteFilter = document.getElementById('estatisticasClienteFilter').value;

                // Construir query com filtros
                let query = supabase
                    .from('clientes_atendimentos')
                    .select(`
                        *,
                        clientes (nome)
                    `, { count: 'exact' });

                // Helper para formatar data para SQL (YYYY-MM-DD HH:MM:SS)
                const pad = (n) => String(n).padStart(2, '0');
                const formatSQLDateTime = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

                // Aplicar filtros de data baseados no campo solicitado_em (intervalos [start, end))
                if (mesFilter && anoFilter) {
                    // Filtro específico por mês e ano
                    const ano = parseInt(anoFilter, 10);
                    const mes = parseInt(mesFilter, 10);

                    const start = new Date(ano, mes - 1, 1, 0, 0, 0);
                    const endExclusive = new Date(ano, mes, 1, 0, 0, 0); // primeiro dia do próximo mês

                    query = query
                        .gte('solicitado_em', formatSQLDateTime(start))
                        .lt('solicitado_em', formatSQLDateTime(endExclusive));
                } else if (mesFilter && !anoFilter) {
                    // Filtro apenas por mês (todos os anos) - usar múltiplos filtros de intervalo
                    const mes = parseInt(mesFilter, 10);

                    // Criar filtros para um intervalo amplo de anos
                    const anosParaFiltrar = [];
                    for (let ano = 2020; ano <= 2030; ano++) {
                        const start = new Date(ano, mes - 1, 1, 0, 0, 0);
                        const endExclusive = new Date(ano, mes, 1, 0, 0, 0);
                        anosParaFiltrar.push({ start: formatSQLDateTime(start), endExclusive: formatSQLDateTime(endExclusive) });
                    }

                    // Aplicar filtro OR para todos os intervalos de anos usando limite exclusivo
                    if (anosParaFiltrar.length > 0) {
                        const orConditions = anosParaFiltrar.map(periodo =>
                            `and(solicitado_em.gte.${periodo.start},solicitado_em.lt.${periodo.endExclusive})`
                        ).join(',');
                        query = query.or(orConditions);
                    }
                } else if (anoFilter && !mesFilter) {
                    // Filtro apenas por ano
                    const ano = parseInt(anoFilter, 10);
                    const start = new Date(ano, 0, 1, 0, 0, 0);
                    const endExclusive = new Date(ano + 1, 0, 1, 0, 0, 0);
                    query = query
                        .gte('solicitado_em', formatSQLDateTime(start))
                        .lt('solicitado_em', formatSQLDateTime(endExclusive));
                }

                if (clienteFilter) {
                    const clienteId = parseInt(clienteFilter, 10);
                    if (!Number.isNaN(clienteId)) {
                        query = query.eq('id_cliente', clienteId);
                    }
                }

                const { data: atendimentos, count: totalCount, error } = await query.range(0, 50000);

                if (error) throw error;

                // Calcular estatísticas
                await calcularEstatisticas(atendimentos, anoFilter, mesFilter, totalCount);

            } catch (error) {
                console.error('Erro ao atualizar estatísticas:', error);
                showNotification('Erro ao carregar estatísticas', 'error');
            }
        }

        async function calcularEstatisticas(atendimentos, anoFilter, mesFilter, totalCount) {
            // Total de atendimentos (usar count exato retornado pelo Supabase para evitar limite padrão 1000)
            const total = (typeof totalCount === 'number' && !Number.isNaN(totalCount)) ? totalCount : atendimentos.length;
            document.getElementById('totalAtendimentos').textContent = total;

            // Média de atendimentos por dia (considerando apenas dias úteis - segunda a sábado)
            if (atendimentos.length > 0) {
                // Filtrar atendimentos com data válida baseado no campo solicitado_em
                const atendimentosComData = atendimentos.filter(a => a.solicitado_em);
                
                if (atendimentosComData.length > 0) {
                    // Calcular período para contar dias úteis
                    let dataInicio, dataFim;
                    
                    if (mesFilter && anoFilter) {
                        // Período específico do mês
                        const ano = parseInt(anoFilter);
                        const mes = parseInt(mesFilter);
                        dataInicio = new Date(ano, mes - 1, 1); // mes - 1 porque Date usa 0-11
                        dataFim = new Date(ano, mes, 0); // último dia do mês
                    } else if (anoFilter) {
                        // Período do ano inteiro
                        const ano = parseInt(anoFilter);
                        dataInicio = new Date(ano, 0, 1);
                        dataFim = new Date(ano, 11, 31);
                    } else {
                        // Usar o período dos dados disponíveis
                        const datas = atendimentosComData.map(a => new Date(a.solicitado_em));
                        dataInicio = new Date(Math.min(...datas));
                        dataFim = new Date(Math.max(...datas));
                    }
                    
                    // Contar dias úteis (segunda a sábado) no período
                    let diasUteis = 0;
                    const dataAtual = new Date(dataInicio);
                    
                    while (dataAtual <= dataFim) {
                        const diaSemana = dataAtual.getDay(); // 0=domingo, 1=segunda, ..., 6=sábado
                        if (diaSemana >= 1 && diaSemana <= 6) { // segunda a sábado
                            diasUteis++;
                        }
                        dataAtual.setDate(dataAtual.getDate() + 1);
                    }
                    
                    const mediaDia = diasUteis > 0 ? (atendimentos.length / diasUteis).toFixed(1) : 0;
                    document.getElementById('mediaAtendimentosDia').textContent = mediaDia;
                } else {
                    document.getElementById('mediaAtendimentosDia').textContent = '0';
                }
            } else {
                document.getElementById('mediaAtendimentosDia').textContent = '0';
            }

            // Tempo médio de atendimento (usando solicitado_em como base, mas mantendo iniciado_em e finalizado_em para cálculo)
            const atendimentosComTempo = atendimentos.filter(a => 
                a.solicitado_em && a.iniciado_em && a.finalizado_em
            );

            if (atendimentosComTempo.length > 0) {
                const tempoTotal = atendimentosComTempo.reduce((total, atendimento) => {
                    const inicio = new Date(atendimento.iniciado_em);
                    const fim = new Date(atendimento.finalizado_em);
                    return total + (fim - inicio);
                }, 0);

                const tempoMedio = tempoTotal / atendimentosComTempo.length;
                const horas = Math.floor(tempoMedio / (1000 * 60 * 60));
                const minutos = Math.floor((tempoMedio % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById('tempoMedioAtendimento').textContent = `${horas}h ${minutos}m`;
            } else {
                document.getElementById('tempoMedioAtendimento').textContent = '0h 0m';
            }

            // Nota média dos clientes (baseado em atendimentos com solicitado_em válido)
            const atendimentosComNota = atendimentos.filter(a => 
                a.solicitado_em && a.nota_do_cliente && !isNaN(parseFloat(a.nota_do_cliente))
            );

            if (atendimentosComNota.length > 0) {
                const somaNotas = atendimentosComNota.reduce((total, atendimento) => 
                    total + parseFloat(atendimento.nota_do_cliente), 0
                );
                const notaMedia = (somaNotas / atendimentosComNota.length).toFixed(1);
                document.getElementById('notaMediaClientes').textContent = notaMedia;
            } else {
                document.getElementById('notaMediaClientes').textContent = '0.0';
            }

            // Top 10 clientes
            await calcularTopClientes(atendimentos);

            // Tipos de atendimento
            await calcularTiposAtendimento(atendimentos);

            // Distribuição de notas
            await calcularDistribuicaoNotas(atendimentos);

            // Atendimentos por dia da semana
            await calcularAtendimentosPorDiaSemana(atendimentos);

            // Atendimentos por atendentes
            await calcularAtendimentosPorAtendentes(atendimentos);

            // Avaliação média por atendente
            await calcularAvaliacaoPorAtendente(atendimentos);
        }

        async function calcularTopClientes(atendimentos) {
            const clientesMap = {};

            atendimentos.forEach(atendimento => {
                const clienteId = atendimento.id_cliente;
                const clienteNome = atendimento.clientes?.nome || 'Cliente não encontrado';
                
                if (!clientesMap[clienteId]) {
                    clientesMap[clienteId] = {
                        nome: clienteNome,
                        atendimentos: 0,
                        notas: []
                    };
                }
                
                clientesMap[clienteId].atendimentos++;
                
                if (atendimento.nota_do_cliente && !isNaN(parseFloat(atendimento.nota_do_cliente))) {
                    clientesMap[clienteId].notas.push(parseFloat(atendimento.nota_do_cliente));
                }
            });

            const topClientes = Object.values(clientesMap)
                .map(cliente => ({
                    ...cliente,
                    notaMedia: cliente.notas.length > 0 
                        ? (cliente.notas.reduce((a, b) => a + b, 0) / cliente.notas.length).toFixed(1)
                        : 'N/A'
                }))
                .sort((a, b) => b.atendimentos - a.atendimentos)
                .slice(0, 10);

            const tbody = document.getElementById('topClientesTable');
            if (topClientes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-info-circle" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p style="color: var(--gray-500); margin-top: 1rem;">Nenhum dado encontrado</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = topClientes.map((cliente, index) => `
                    <tr>
                        <td>${index + 1}º</td>
                        <td>${cliente.nome}</td>
                        <td>${cliente.atendimentos}</td>
                        <td>${cliente.notaMedia}</td>
                    </tr>
                `).join('');
            }
        }

        async function calcularTiposAtendimento(atendimentos) {
            const tiposMap = {};

            atendimentos.forEach(atendimento => {
                const tipo = atendimento.tipo_de_atendimento || 'Não informado';
                tiposMap[tipo] = (tiposMap[tipo] || 0) + 1;
            });

            const tipos = Object.entries(tiposMap)
                .map(([tipo, quantidade]) => ({
                    tipo,
                    quantidade,
                    percentual: atendimentos.length > 0 
                        ? ((quantidade / atendimentos.length) * 100).toFixed(1)
                        : 0
                }))
                .sort((a, b) => b.quantidade - a.quantidade);

            const tbody = document.getElementById('tiposAtendimentoTable');
            if (tipos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-info-circle" style="font-size: 2rem; color: var(--gray-400);"></i>
                            <p style="color: var(--gray-500); margin-top: 1rem;">Nenhum dado encontrado</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = tipos.map(tipo => `
                    <tr>
                        <td>${tipo.tipo}</td>
                        <td>${tipo.quantidade}</td>
                        <td>${tipo.percentual}%</td>
                    </tr>
                `).join('');
            }
        }

        async function calcularDistribuicaoNotas(atendimentos) {
            const notasCount = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };

            atendimentos.forEach(atendimento => {
                const nota = parseInt(atendimento.nota_do_cliente);
                if (nota >= 1 && nota <= 5) {
                    notasCount[nota]++;
                }
            });

            const totalNotas = Object.values(notasCount).reduce((a, b) => a + b, 0);

            for (let nota = 1; nota <= 5; nota++) {
                const count = notasCount[nota];
                const percentual = totalNotas > 0 ? (count / totalNotas) * 100 : 0;
                
                document.getElementById(`nota${nota}Count`).textContent = count;
                document.getElementById(`nota${nota}Progress`).style.width = `${percentual}%`;
            }
        }

        async function calcularAtendimentosPorDiaSemana(atendimentos) {
            // Inicializar contadores para cada dia da semana
            const diasSemana = {
                0: { nome: 'domingo', count: 0 },
                1: { nome: 'segunda', count: 0 },
                2: { nome: 'terca', count: 0 },
                3: { nome: 'quarta', count: 0 },
                4: { nome: 'quinta', count: 0 },
                5: { nome: 'sexta', count: 0 },
                6: { nome: 'sabado', count: 0 }
            };

            // Contar atendimentos por dia da semana baseado no campo solicitado_em
            atendimentos.forEach(atendimento => {
                if (atendimento.solicitado_em) {
                    const data = new Date(atendimento.solicitado_em);
                    const diaSemana = data.getDay(); // 0=domingo, 1=segunda, ..., 6=sábado
                    diasSemana[diaSemana].count++;
                }
            });

            // Encontrar o maior valor para calcular percentuais
            const maxCount = Math.max(...Object.values(diasSemana).map(dia => dia.count));

            // Atualizar os elementos HTML
            Object.values(diasSemana).forEach(dia => {
                const count = dia.count;
                const percentual = maxCount > 0 ? (count / maxCount) * 100 : 0;
                
                document.getElementById(`${dia.nome}Count`).textContent = count;
                document.getElementById(`${dia.nome}Progress`).style.width = `${percentual}%`;
            });
        }

        async function calcularAtendimentosPorAtendentes(atendimentos) {
            const atendentesStats = {};
            let totalAtendimentos = 0;

            // Contar atendimentos por atendente
            atendimentos.forEach(atendimento => {
                if (atendimento.participantes && atendimento.participantes.trim()) {
                    // Dividir participantes por vírgula e processar cada um
                    const participantes = atendimento.participantes.split(',').map(p => p.trim());
                    
                    participantes.forEach(participante => {
                        if (participante) {
                            if (!atendentesStats[participante]) {
                                atendentesStats[participante] = 0;
                            }
                            atendentesStats[participante]++;
                            totalAtendimentos++;
                        }
                    });
                }
            });

            // Ordenar atendentes por número de atendimentos (decrescente)
            const atendentesOrdenados = Object.entries(atendentesStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Top 10 atendentes

            // Limpar container
            const container = document.getElementById('atendentesContainer');
            container.innerHTML = '';

            // Adicionar cada atendente
            atendentesOrdenados.forEach(([nome, quantidade]) => {
                const porcentagem = totalAtendimentos > 0 ? ((quantidade / totalAtendimentos) * 100).toFixed(1) : 0;
                const maxWidth = atendentesOrdenados.length > 0 ? (quantidade / atendentesOrdenados[0][1]) * 100 : 0;

                const atendenteDiv = document.createElement('div');
                atendenteDiv.className = 'avaliacao-item';
                atendenteDiv.innerHTML = `
                    <span class="avaliacao-label" title="${nome}">${nome.length > 20 ? nome.substring(0, 20) + '...' : nome}</span>
                    <div class="avaliacao-bar">
                        <div class="avaliacao-progress" style="width: ${maxWidth}%; background-color: #3b82f6;"></div>
                    </div>
                    <span class="avaliacao-count">${quantidade} (${porcentagem}%)</span>
                `;
                container.appendChild(atendenteDiv);
            });

            // Se não houver dados
            if (atendentesOrdenados.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Nenhum atendente encontrado</p>';
            }
        }

        async function calcularAvaliacaoPorAtendente(atendimentos) {
            const avaliacaoPorAtendente = {};

            atendimentos.forEach(atendimento => {
                const nota = parseFloat(atendimento.nota_do_cliente);
                const participantesStr = atendimento.participantes;

                if (!isNaN(nota) && nota >= 1 && nota <= 5 && participantesStr && participantesStr.trim()) {
                    const participantes = participantesStr.split(',').map(p => p.trim()).filter(Boolean);

                    participantes.forEach(participante => {
                        if (!avaliacaoPorAtendente[participante]) {
                            avaliacaoPorAtendente[participante] = { soma: 0, count: 0 };
                        }
                        avaliacaoPorAtendente[participante].soma += nota;
                        avaliacaoPorAtendente[participante].count += 1;
                    });
                }
            });

            const container = document.getElementById('avaliacaoAtendenteContainer');
            container.innerHTML = '';

            const lista = Object.entries(avaliacaoPorAtendente)
                .map(([nome, dados]) => ({
                    nome,
                    media: dados.count > 0 ? (dados.soma / dados.count) : 0,
                    count: dados.count
                }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            lista.forEach(item => {
                const nomeExibicao = item.nome.length > 20 ? item.nome.substring(0, 20) + '...' : item.nome;
                const percentual = (item.media / 5) * 100; // barra baseada na média 1-5
                const avaliacaoDiv = document.createElement('div');
                avaliacaoDiv.className = 'avaliacao-item';
                avaliacaoDiv.innerHTML = `
                    <span class="avaliacao-label" title="${item.nome}">${nomeExibicao}</span>
                    <div class="avaliacao-bar">
                        <div class="avaliacao-progress" style="width: ${percentual.toFixed(1)}%; background-color: #10b981;"></div>
                    </div>
                    <span class="avaliacao-count">${item.media.toFixed(1)} (${item.count})</span>
                `;
                container.appendChild(avaliacaoDiv);
            });

            if (lista.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Nenhuma avaliação encontrada</p>';
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
